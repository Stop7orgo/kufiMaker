<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>kufiMaker</title>

<!-- â”€â”€ Favicon â”€â”€ -->
<link rel="icon" type="image/x-icon" href="https://ab7dz.github.io/kufiMaker/screenshots/kufimaker.ico"/>

<!-- â”€â”€ PWA Manifest â”€â”€ -->
<link rel="manifest" href="manifest.json"/>

<!-- â”€â”€ PWA Meta Tags â”€â”€ -->
<meta name="theme-color" content="#F5A623"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="kufiMaker"/>

<!-- â”€â”€ Apple Touch Icons (required for iOS Add to Home Screen) â”€â”€ -->
<link rel="apple-touch-icon" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png"/>
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png"/>

<!-- â”€â”€ SEO â”€â”€ -->
<meta name="description" content="kufiMaker â€” Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. Square Kufic Script Editor."/>
<meta name="keywords" content="Ø®Ø· ÙƒÙˆÙÙŠ, ÙƒÙˆÙÙŠ Ù…Ø±Ø¨Ø¹, Ù…Ø­Ø±Ø± Ø®Ø· Ø¹Ø±Ø¨ÙŠ, pixel art Ø¹Ø±Ø¨ÙŠ, kufi, arabic calligraphy, kufi square, free arabic font tool"/>
<meta name="author" content="Ø§Ø³Ù…Ùƒ"/>
<link rel="canonical" href="https://ab7dz.github.io/kufimaker/"/>

<!-- Open Graph â€” ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØªÙˆÙŠØªØ± ØªØ¸Ù‡Ø± Ø¨ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ù…ÙŠÙ„ -->
<meta property="og:title" content="kufiMaker â€” Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹"/>
<meta property="og:description" content="Ø£Ù†Ø´Ø¦ Ø­Ø±ÙˆÙØ§Ù‹ ÙƒÙˆÙÙŠØ© Ù…Ø±Ø¨Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙÙŠ Ù…ØªØµÙØ­Ùƒ"/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://ab7dz.github.io/kufimaker/"/>
<meta property="og:locale" content="ar_SA"/>

<!-- â”€â”€ Fonts â”€â”€ -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#F5A623;--accent2:#FF6B35;
  --bg:#0A0C10;--surface:#111318;--surface2:#181B22;--surface3:#1E2229;
  --border:rgba(255,255,255,0.06);--text:#E8ECF4;--muted:#6B7280;
  --cell-bg:#0D1017;--cell-size:30px;--gap:15px;--r:12px;--rs:8px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;max-height:-webkit-fill-available;max-height:100dvh;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;height:-webkit-fill-available;height:100dvh;}
/* Fix landscape on mobile: grid must scroll in both axes freely */
#main{display:flex;flex:1;overflow:hidden;position:relative;min-height:0;min-width:0;}
#canvasArea{flex:1;position:relative;overflow:clip;background:var(--bg);order:1;min-height:0;min-width:0;}
#canvasViewport{
  position:absolute;inset:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  cursor:crosshair;
}
#canvasViewport.pan-mode{cursor:grab;}
#canvasViewport.pan-mode:active{cursor:grabbing;}

/* TOP BAR â€” Two rows */
#topbar{
  background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;flex-direction:column;
  flex-shrink:0;z-index:100;
}
/* Row 1: Logo left + Panel buttons right */
#topbarRow1{
  height:48px;display:flex;align-items:center;
  padding:0 10px;gap:6px;
  border-bottom:1px solid var(--border);
}
.tb-logo{
  display:flex;align-items:center;gap:8px;
  text-decoration:none;flex-shrink:0;
}
.tb-logo-mark{
  width:30px;height:30px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-size:14px;font-weight:900;color:#fff;
  flex-shrink:0;
  box-shadow:0 2px 10px rgba(245,166,35,0.4);
}
.tb-logo-text{
  font-size:14px;font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  white-space:nowrap;
}
.tb-logo-sub{font-size:10px;color:var(--muted);margin-top:-2px;}
#topbarRow1 .spacer{flex:1;}
/* Row 2: action buttons */
#topbarRow2{
  height:40px;display:flex;align-items:center;
  padding:0 10px;gap:5px;
  overflow-x:auto;overflow-y:hidden;
}
#topbarRow2::-webkit-scrollbar{display:none;}

/* Topbar buttons */
.tb-btn{
  position:relative;
  width:32px;height:32px;
  border-radius:var(--rs);
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .15s;flex-shrink:0;
}
.tb-btn:hover{background:var(--surface3);}
.tb-btn svg{width:15px;height:15px;flex-shrink:0;pointer-events:none;}
.tb-btn.sheet-active{background:var(--accent);color:#000;border-color:var(--accent);}
.sep{width:1px;height:20px;background:var(--border);flex-shrink:0;}

/* Sheet-trigger buttons in row1 â€” slightly larger */
.tb-panel-btn{
  position:relative;
  width:36px;height:36px;
  border-radius:var(--rs);
  border:1px solid var(--border);
  background:var(--surface2);color:var(--text);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:2px;
  cursor:pointer;transition:all .15s;flex-shrink:0;
}
.tb-panel-btn svg{width:16px;height:16px;flex-shrink:0;pointer-events:none;}
.tb-panel-btn span{font-size:9px;font-family:'Tajawal',sans-serif;color:var(--muted);line-height:1;pointer-events:none;}
.tb-panel-btn:hover{background:var(--surface3);}
.tb-panel-btn.sheet-active{background:var(--accent);color:#000;border-color:var(--accent);}
.tb-panel-btn.sheet-active span{color:#000;}

/* Tooltip */
[data-tip]{position:relative;}
[data-tip]::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1a1d25;color:var(--text);font-size:11px;font-family:'Tajawal',sans-serif;white-space:nowrap;padding:4px 9px;border-radius:6px;border:1px solid var(--border);pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;}
[data-tip]::before{content:'';position:absolute;bottom:calc(100% + 3px);left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1a1d25;pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;}
[data-tip]:hover::after,[data-tip]:hover::before{opacity:1;}

/* â”€â”€ WELCOME SCREEN â”€â”€ */
#welcomeScreen{position:fixed;inset:0;z-index:5000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;padding:24px;}
#welcomeScreen.hidden{display:none;}
.wl-logo{font-size:42px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;letter-spacing:-1px;}
.wl-sub{font-size:13px;color:var(--muted);margin-bottom:32px;}
.wl-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;width:100%;max-width:480px;margin-bottom:28px;}
.wl-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px 14px;text-align:center;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:8px;}
.wl-card:hover{border-color:var(--accent);background:var(--surface2);transform:translateY(-2px);}
.wl-card-icon{font-size:28px;}
.wl-card-title{font-size:13px;font-weight:700;}
.wl-card-desc{font-size:10px;color:var(--muted);}
.wl-actions{display:flex;flex-direction:column;gap:8px;width:100%;max-width:480px;}
.wl-btn{width:100%;padding:13px;border-radius:var(--r);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'Tajawal',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;}
.wl-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;border-color:transparent;}
.wl-btn.primary:hover{opacity:.9;}
.wl-btn:hover{background:var(--surface3);}
.wl-restore-info{font-size:11px;color:var(--muted);margin-top:6px;text-align:center;}

/* â”€â”€ BOTTOM SHEET / MODAL PANEL â”€â”€ */
/* Overlay â€” mobile: dim background, desktop: hidden via JS class */
#sheetOverlay{
  position:fixed;inset:0;z-index:200;
  pointer-events:none;
  display:flex;
  align-items:flex-end;  /* mobile: sheet sticks to bottom */
  justify-content:stretch;
  background:rgba(0,0,0,0);
  transition:background .28s;
}
#sheetOverlay.open{
  pointer-events:auto;
  background:rgba(0,0,0,0.50);
}

/* Sheet itself */
#bottomSheet{
  width:100%;
  background:var(--surface);
  border-radius:22px 22px 0 0;
  border-top:1px solid var(--border);
  height:50vh; min-height:300px;
  display:flex;flex-direction:column;
  transform:translateY(102%);
  transition:transform .32s cubic-bezier(.4,0,.2,1);
  position:relative; z-index:1;
  touch-action:pan-x;
}
#bottomSheet.open{transform:translateY(0);}

.bs-handle{width:40px;height:4px;background:rgba(255,255,255,0.12);border-radius:4px;margin:10px auto 4px;flex-shrink:0;}
.bs-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 12px;flex-shrink:0;}
.bs-tab{flex:1;padding:10px 4px;font-size:12px;font-weight:700;font-family:'Tajawal',sans-serif;text-align:center;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;}
.bs-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.bs-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--surface2);color:var(--muted);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:center;margin-right:8px;}
.bs-close:hover{background:var(--surface3);color:var(--text);}
.bs-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 16px 32px;display:flex;flex-direction:column;gap:10px;}
.bs-content::-webkit-scrollbar{width:3px;}
.bs-content::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}

/* Desktop: centered modal */
@media(min-width:768px){
  #sheetOverlay{align-items:center;justify-content:center;}
  /* Completely remove from layout when closed */
  #sheetOverlay:not(.open){display:none;}
  #bottomSheet{
    width:310px;max-width:92vw;border-radius:var(--r);
    border:1px solid var(--border);
    height:auto;max-height:82vh;min-height:0;
    transform:translateY(-12px);opacity:0;
    transition:opacity .18s ease,transform .18s ease;
    pointer-events:none;
    touch-action:auto;
  }
  #bottomSheet.open{transform:translateY(0);opacity:1;pointer-events:auto;}
  .bs-handle{display:none;}
}

.tb-btn.sheet-active{background:var(--accent);color:#000;border-color:var(--accent);}

/* â”€â”€ MAIN â”€â”€ */
#main{display:flex;flex:1;overflow:hidden;position:relative;min-height:0;}

/* â”€â”€ FLOATING TOOLBAR â€” top right, fixed â”€â”€ */
#leftPanel{
  position:fixed;
  right:14px; top:calc(var(--topbar-h, 90px) + 10px);
  background:rgba(13,15,20,0.92);
  backdrop-filter:blur(18px);
  -webkit-backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,0.09);
  border-radius:18px;
  box-shadow:0 8px 32px rgba(0,0,0,0.65), inset 0 1px 0 rgba(255,255,255,0.05);
  display:flex;flex-direction:column;align-items:center;
  padding:10px 7px;gap:4px;
  z-index:60;
}
#floatSwatches{display:flex;flex-direction:column;align-items:center;gap:4px;width:100%;}
.float-swatch{
  width:26px;height:26px;border-radius:8px;
  border:2px solid transparent;
  cursor:pointer;flex-shrink:0;
  transition:transform .1s, border-color .1s;
}
.float-swatch:hover{transform:scale(1.15);}
.float-swatch.selected{border-color:#fff;transform:scale(1.1);}

/* Color dropdown */
#colorDropdown{
  display:none;
  position:absolute;
  right:calc(100% + 10px);
  top:0;
  background:rgba(13,15,20,0.96);
  backdrop-filter:blur(18px);
  -webkit-backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:14px;
  box-shadow:0 8px 28px rgba(0,0,0,0.7);
  padding:8px 7px;
  flex-direction:column;
  align-items:center;
  gap:4px;
  z-index:70;
  min-width:40px;
}
#colorDropdown.open{display:flex;}
.tool-btn{
  width:40px;height:40px;border-radius:12px;
  border:none;background:transparent;
  color:rgba(255,255,255,0.40);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .13s;flex-shrink:0;
}
.tool-btn:hover{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.88);}
.tool-btn.active{background:var(--accent);color:#1a0a00;box-shadow:0 2px 10px rgba(245,166,35,0.45);}
.tool-sep{height:1px;width:26px;background:rgba(255,255,255,0.09);margin:3px 0;flex-shrink:0;}

/* CANVAS AREA */
/* CANVAS AREA â€” defined above near body */
/* gridCanvas: inline-grid so it sizes to content */
#gridCanvas{display:inline-grid;gap:var(--gap);padding:20px;position:relative;min-width:max-content;transform-origin:top left;}
.cell{width:var(--cell-size);height:var(--cell-size);background:var(--cell-bg);border-radius:3px;transition:background .07s;cursor:inherit;}
.cell.filled{background:var(--accent);}
/* bgLayer: SIBLING of gridCanvas, positioned to match gc via JS â€” this allows mix-blend-mode to work */
#bgLayer{position:absolute;pointer-events:none;top:0;left:0;transform-origin:top left;}

/* bg-frame base */
.bg-frame{position:absolute;box-sizing:border-box;pointer-events:auto;z-index:5;touch-action:none;}
#coordsBar{position:fixed;bottom:35px;left:12px;background:rgba(0,0,0,0.72);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:20px;padding:3px 14px;font-size:11px;color:var(--muted);pointer-events:none;z-index:62;}
#zoomCtrl{position:fixed;bottom:35px;right:25%;transform:translateX(50%);display:flex;gap:4px;z-index:62;}
.zoom-btn{width:30px;height:30px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;}
#zoomLevel{padding:0 8px;height:30px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:11px;display:flex;align-items:center;}
=
/* RIGHT PANEL */
#rightPanel{width:285px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:50;order:3;transition:transform .25s ease,width .25s ease;}
#rightPanel.collapsed{transform:translateX(100%);width:0;overflow:hidden;}
#panelTabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.panel-tab{flex:1;padding:10px 4px;font-size:11px;font-weight:700;font-family:'Tajawal',sans-serif;text-align:center;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;}
.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
#panelContent{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px;display:flex;flex-direction:column;gap:10px;}
#panelContent::-webkit-scrollbar{width:3px;}
#panelContent::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}
.sec{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;}

/* Panel toggle */
#panelToggle{position:absolute;top:50%;left:0;transform:translateY(-50%);width:18px;height:44px;background:var(--surface2);border:1px solid var(--border);border-right:none;border-radius:0 var(--rs) var(--rs) 0;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;z-index:60;transition:background .15s;}
#panelToggle:hover{background:var(--surface3);color:var(--text);}

/* Controls */
.ctrl-row{display:flex;align-items:center;gap:7px;margin-bottom:5px;}
.ctrl-label{font-size:12px;color:var(--muted);flex-shrink:0;}
.ctrl-val{font-size:12px;color:var(--text);min-width:30px;text-align:center;flex-shrink:0;}
input[type=range]{flex:1;-webkit-appearance:none;height:4px;background:var(--surface3);border-radius:4px;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:15px;height:15px;background:var(--accent);border-radius:50%;cursor:pointer;}
input[type=number]{background:var(--surface3);border:1px solid var(--border);color:var(--text);padding:5px 7px;border-radius:var(--rs);font-size:12px;font-family:'Tajawal',sans-serif;outline:none;text-align:center;width:100%;}
input[type=number]:focus{border-color:var(--accent);}
.color-btn{width:30px;height:30px;border-radius:var(--rs);border:2px solid var(--border);overflow:hidden;flex-shrink:0;cursor:pointer;}
input[type=color]{width:100%;height:100%;border:none;cursor:pointer;padding:0;}

/* Buttons */
.s-btn{padding:6px 8px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;font-family:'Tajawal',sans-serif;cursor:pointer;text-align:center;transition:all .12s;white-space:nowrap;}
.s-btn:hover{background:var(--surface3);}
.s-btn.accent{background:var(--accent);color:#000;border-color:var(--accent);}
.s-btn.danger{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:#f87171;}
.s-btn.full{width:100%;}
.btn-group{display:flex;gap:5px;flex-wrap:wrap;}

/* Letter library */
#letterLibrary{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
.letter-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:7px 3px 5px;cursor:pointer;transition:all .15s;gap:3px;user-select:none;}
.letter-card:hover{background:var(--surface3);border-color:rgba(245,166,35,0.4);}
.letter-card:active{transform:scale(0.94);}
.lc-char{font-size:20px;font-weight:700;}
.lc-name{font-size:9px;color:var(--muted);}
.lc-preview{display:grid;gap:1px;background:var(--surface3);padding:2px;border-radius:3px;}
.lc-dot{width:4px;height:4px;border-radius:1px;background:var(--cell-bg);}
.lc-dot.on{background:var(--accent);}

/* Swatches */
.swatches{display:flex;flex-wrap:wrap;gap:5px;}
.swatch{width:24px;height:24px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all .12s;}
.swatch:hover,.swatch.selected{border-color:#fff;transform:scale(1.1);}

/* Letter editor modal */
#letterEditorModal{position:fixed;inset:0;z-index:1000;display:none;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;}
#letterEditorModal.open{display:flex;}
.le-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;width:min(96vw,420px);max-height:92vh;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
.le-title{font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:space-between;}
.le-title .le-close{cursor:pointer;font-size:18px;color:var(--muted);padding:2px 6px;border-radius:4px;}
.le-title .le-close:hover{background:var(--surface2);color:var(--text);}
.le-fields{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.le-field label{font-size:10px;color:var(--muted);display:block;margin-bottom:3px;}
.le-field input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:var(--rs);font-family:'Tajawal',sans-serif;font-size:13px;outline:none;}
.le-field input:focus{border-color:var(--accent);}
.le-grid-controls{display:flex;align-items:center;gap:8px;font-size:11px;}
.le-grid-controls input[type=number]{width:44px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:4px;border-radius:var(--rs);font-family:'Tajawal',sans-serif;text-align:center;outline:none;}
.le-tool-btn{padding:4px 10px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:'Tajawal',sans-serif;font-size:11px;cursor:pointer;}
.le-tool-btn.active{background:var(--accent);color:#000;border-color:var(--accent);}
.le-editor-grid{position:relative;background:var(--surface3);border-radius:var(--rs);cursor:crosshair;display:inline-block;touch-action:none;user-select:none;}
.le-gcell{position:absolute;border-radius:2px;background:#1a1d25;box-sizing:border-box;cursor:crosshair;}
.le-gcell.on{background:var(--accent);}
.le-gH{position:absolute;background:rgba(255,255,255,0.05);box-sizing:border-box;cursor:crosshair;}
.le-gH.on{background:var(--accent);}
.le-gV{position:absolute;background:rgba(255,255,255,0.05);box-sizing:border-box;cursor:crosshair;}
.le-gV.on{background:var(--accent);}
.le-gD{position:absolute;background:rgba(255,255,255,0.03);box-sizing:border-box;cursor:crosshair;}
.le-gD.on{background:var(--accent);}
.le-editor-wrap{display:flex;justify-content:center;overflow:auto;}
.le-cell{border-radius:2px;background:var(--cell-bg);transition:background .07s;}
.le-cell.on{background:var(--accent);}
.le-cell:hover{opacity:0.8;}
.le-actions{display:flex;gap:6px;flex-wrap:wrap;}
.le-btn{flex:1;padding:8px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-family:'Tajawal',sans-serif;font-size:12px;cursor:pointer;transition:background .12s;}
.le-btn:hover{background:var(--surface3);}
.le-btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700;}
.le-btn.primary:hover{opacity:0.9;}
.le-btn.danger{border-color:rgba(239,68,68,0.5);color:#ef4444;}
.le-btn.danger:hover{background:rgba(239,68,68,0.1);}
/* letter card actions */
.letter-card{position:relative;}
.lc-actions{position:absolute;top:2px;left:2px;display:none;gap:3px;}
.letter-card:hover .lc-actions{display:flex;}
.lc-act-btn{width:18px;height:18px;border-radius:3px;border:none;background:var(--surface3);color:var(--muted);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.lc-act-btn:hover{background:var(--accent);color:#000;}
/* lib header */
#libHeader{display:flex;align-items:center;gap:6px;margin-bottom:6px;flex-wrap:wrap;}
#libSearch{flex:1;min-width:80px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:var(--rs);font-family:'Tajawal',sans-serif;font-size:12px;outline:none;}
#libSearch:focus{border-color:var(--accent);}
.lib-icon-btn{width:28px;height:28px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface2);color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;flex-shrink:0;}
.lib-icon-btn:hover{background:var(--accent);color:#000;}

/* Upload zone */
.upload-zone{border:1.5px dashed var(--border);border-radius:var(--rs);padding:14px;text-align:center;cursor:pointer;transition:border-color .15s;font-size:12px;color:var(--muted);}
.upload-zone:hover{border-color:var(--accent);}
.upload-zone input{display:none;}

/* Size grid */
.size-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}

/* Axis lines (drawn on canvas layer) */
.axis-h,.axis-v{position:absolute;pointer-events:none;z-index:3;}

/* Status bar */
#statusBar{height:26px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:14px;flex-shrink:0;font-size:11px;color:var(--muted);}
#statusBar b{color:var(--text);}

/* Modal */
#modalOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;align-items:center;justify-content:center;}
#modalOverlay.open{display:flex;}
#modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;max-width:320px;width:90%;text-align:center;display:flex;flex-direction:column;gap:12px;}
#modal h3{font-size:15px;font-weight:700;}
#modal p{font-size:13px;color:var(--muted);}
.modal-btns{display:flex;gap:8px;}

/* Scrollbars */
#canvasViewport::-webkit-scrollbar{width:5px;height:5px;}
#canvasViewport::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}

/* â”€â”€ BG handles: BLUE when drag mode active â”€â”€ */
.bg-handle{
  position:absolute;width:16px;height:16px;
  background:#1565C0;border:2px solid #42A5F5;
  border-radius:3px;box-shadow:0 2px 6px rgba(0,0,0,0.5);
  touch-action:none;display:block;z-index:6;
}
.bg-handle:hover{background:#1976D2;}
.bg-handle.tl{left:-10px;top:-10px;cursor:nwse-resize;}
.bg-handle.tr{right:-10px;top:-10px;cursor:nesw-resize;}
.bg-handle.bl{left:-10px;bottom:-10px;cursor:nesw-resize;}
.bg-handle.br{right:-10px;bottom:-10px;cursor:nwse-resize;}
.bg-handle.tm{left:50%;transform:translateX(-50%);top:-10px;cursor:ns-resize;}
.bg-handle.bm{left:50%;transform:translateX(-50%);bottom:-10px;cursor:ns-resize;}
.bg-handle.lm{left:-10px;top:50%;transform:translateY(-50%);cursor:ew-resize;}
.bg-handle.rm{right:-10px;top:50%;transform:translateY(-50%);cursor:ew-resize;}
.bg-handle.rot{left:50%;transform:translateX(-50%);top:-38px;width:16px;height:16px;border-radius:50%;background:#0D47A1;border:2px solid #64B5F6;cursor:crosshair;}
.rot-line{position:absolute;left:50%;top:-28px;width:2px;height:22px;background:rgba(66,165,245,0.6);transform:translateX(-50%);pointer-events:none;}

/* â”€â”€ Letter block overlay â”€â”€ */
.block-overlay{position:absolute;z-index:20;cursor:move;border:2px dashed rgba(245,166,35,0.6);border-radius:4px;pointer-events:auto;touch-action:none;box-sizing:border-box;}
.block-overlay:hover{border-color:rgba(245,166,35,1);background:rgba(245,166,35,0.04);}
.block-overlay-label{position:absolute;top:-20px;right:0;font-size:11px;color:var(--accent);background:var(--surface);padding:1px 6px;border-radius:4px;border:1px solid var(--border);font-family:'Tajawal',sans-serif;white-space:nowrap;pointer-events:none;}
.block-overlay-hint{position:absolute;bottom:-18px;right:0;font-size:9px;color:var(--muted);font-family:'Tajawal',sans-serif;white-space:nowrap;pointer-events:none;}
.block-merge-btn{
  position:absolute;top:-18px;left:0;
  width:28px;height:20px;border-radius:5px;
  background:var(--accent);color:#000;
  border:none;font-size:13px;font-weight:900;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(245,166,35,0.5);
  z-index:21;touch-action:manipulation;
  line-height:1;
}
.block-merge-btn:hover{opacity:.85;}

/* â”€â”€ Rulers â”€â”€ */
#rulerH,#rulerV{position:absolute;z-index:30;pointer-events:auto;touch-action:none;}
#rulerH{left:0;right:0;height:3px;background:#00BFFF;cursor:ns-resize;box-shadow:0 0 8px rgba(0,191,255,0.8);}
#rulerH::after{content:attr(data-row);position:absolute;left:8px;top:-20px;font-size:10px;color:#00BFFF;background:rgba(0,0,0,0.7);padding:1px 6px;border-radius:3px;pointer-events:none;}
#rulerV{top:0;bottom:0;width:3px;background:#00BFFF;cursor:ew-resize;box-shadow:0 0 8px rgba(0,191,255,0.8);}
#rulerV::after{content:attr(data-col);position:absolute;left:6px;top:8px;font-size:10px;color:#00BFFF;background:rgba(0,0,0,0.7);padding:1px 6px;border-radius:3px;pointer-events:none;}

/* â”€â”€ Line cells between cells â”€â”€ */
.line-h,.line-v{position:absolute;pointer-events:auto;cursor:crosshair;z-index:4;transition:background .07s;}
.line-h{height:var(--gap);background:rgba(127,0,0,0.25);}
.line-v{width:var(--gap);background:rgba(127,0,0,0.25);}
.line-h.filled,.line-v.filled{background:var(--accent)!important;}
/* corner dot at intersections */
.line-dot{position:absolute;z-index:5;pointer-events:auto;cursor:crosshair;transition:background .07s;}
.line-dot.filled{background:var(--accent)!important;}
</style>
</head>
<body>

<!-- WELCOME SCREEN -->
<div id="welcomeScreen">
  <div class="wl-logo">kufiMaker âœ¦</div>
  <div class="wl-sub">Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹</div>
  <div class="wl-cards">
    <div class="wl-card" id="wlNew">
      <div class="wl-card-icon">âœ¨</div>
      <div class="wl-card-title">Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</div>
      <div class="wl-card-desc">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±</div>
    </div>
    <div class="wl-card" id="wlRestore" style="display:none">
      <div class="wl-card-icon">ğŸ”„</div>
      <div class="wl-card-title">Ø§Ø³ØªÙ…Ø± Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª</div>
      <div class="wl-card-desc" id="wlRestoreDesc">Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©</div>
    </div>
    <div class="wl-card" id="wlLoad">
      <div class="wl-card-icon">ğŸ“‚</div>
      <div class="wl-card-title">ÙØªØ­ Ù…Ù„Ù</div>
      <div class="wl-card-desc">JSON Ù…Ø­ÙÙˆØ¸</div>
    </div>
  </div>
  <div class="wl-actions">
    <button class="wl-btn primary" id="wlEnter">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙ…ÙŠÙ… â†’</button>
  </div>
  <div class="wl-restore-info" id="wlInfo"></div>
</div>

<!-- TOP BAR -->
<div id="topbar">
  <!-- Row 1: Logo + Panel Tabs -->
  <div id="topbarRow1">
    <!-- Logo left -->
    <div class="tb-logo">
      <img src="icons/icon-192.png" alt="kufiMaker" style="width:34px;height:34px;border-radius:10px;flex-shrink:0;"/>
      <div>
        <div class="tb-logo-text">kufiMaker</div>
        <div class="tb-logo-sub">Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹</div>
      </div>
    </div>
    <div class="spacer"></div>
    <!-- About button -->
    <button class="tb-panel-btn" id="tbAbout" data-tip="Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±" data-sheet="about" style="margin-left:2px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
      <span>Ø§Ù„Ù…Ø·ÙˆØ±</span>
    </button>
    <div style="width:1px;height:28px;background:var(--border);margin:0 4px;flex-shrink:0;"></div>
    <!-- Panel buttons right -->
    <button class="tb-panel-btn" id="tbTools" data-tip="Ø£Ø¯ÙˆØ§Øª" data-sheet="tools">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/></svg>
      <span>Ø£Ø¯ÙˆØ§Øª</span>
    </button>
    <button class="tb-panel-btn" id="tbGrid" data-tip="Ø§Ù„Ø´Ø¨ÙƒØ©" data-sheet="grid">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      <span>Ø´Ø¨ÙƒØ©</span>
    </button>
    <button class="tb-panel-btn" id="tbLetters" data-tip="Ø§Ù„Ø­Ø±ÙˆÙ" data-sheet="letters">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M6 20V4l6 8 6-8v16"/></svg>
      <span>Ø­Ø±ÙˆÙ</span>
    </button>
    <button class="tb-panel-btn" id="tbBg" data-tip="Ø§Ù„Ø®Ù„ÙÙŠØ©" data-sheet="bg">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      <span>Ø®Ù„ÙÙŠØ©</span>
    </button>
  </div>
  <!-- Row 2: Action buttons -->
  <div id="topbarRow2">
    <button class="tb-btn" id="btnUndo" data-tip="ØªØ±Ø§Ø¬Ø¹ (Ctrl+Z)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg>
    </button>
    <button class="tb-btn" id="btnRedo" data-tip="Ø¥Ø¹Ø§Ø¯Ø© (Ctrl+Y)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg>
    </button>
    <div class="sep"></div>
    <button class="tb-btn" id="btnClear" data-tip="Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
    </button>
    <div class="sep"></div>
    <button class="tb-btn" id="btnExport" data-tip="ØªØµØ¯ÙŠØ± PNG">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    </button>
    <button class="tb-btn" id="btnSaveJSON" data-tip="Ø­ÙØ¸ JSON">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    </button>
    <button class="tb-btn" id="btnLoadJSON" data-tip="ÙØªØ­ Ù…Ù„Ù JSON">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    </button>
    <input type="file" id="loadFileInput" accept=".json" style="display:none"/>
  </div>
</div>

<!-- BOTTOM SHEET -->
<div id="sheetOverlay">
  <div id="bottomSheet" dir="rtl">
    <div class="bs-handle"></div>
    <div style="display:flex;align-items:center;padding:8px 16px 0;">
      <div class="bs-tabs" id="bsTabs" style="flex:1;padding:0;">
        <div class="bs-tab active" data-sheet="tools">Ø£Ø¯ÙˆØ§Øª</div>
        <div class="bs-tab" data-sheet="grid">Ø§Ù„Ø´Ø¨ÙƒØ©</div>
        <div class="bs-tab" data-sheet="letters">Ø§Ù„Ø­Ø±ÙˆÙ</div>
        <div class="bs-tab" data-sheet="bg">Ø§Ù„Ø®Ù„ÙÙŠØ©</div>
        <div class="bs-tab" data-sheet="about">Ø§Ù„Ù…Ø·ÙˆØ±</div>
      </div>
      <button class="bs-close" id="bsClose">âœ•</button>
    </div>
    <div class="bs-content" id="bsContent"></div>
  </div>
</div>

<!-- MAIN -->
<div id="main">

  <!-- Canvas -->
  <div id="canvasArea">
    <div id="canvasViewport">
      <div id="gridCanvas"></div>
      <div id="bgLayer"></div>
      <div id="rulerH" data-row="" style="display:none;top:100px;"></div>
      <div id="rulerV" data-col="" style="display:none;left:100px;"></div>
    </div>
    <div id="coordsBar">X: 0 â€” Y: 0</div>

    <!-- Zoom controls â€” bottom left -->
    <div id="zoomCtrl">
      <button class="zoom-btn" id="zoomOut2" data-tip="ØªØµØºÙŠØ±">âˆ’</button>
      <div id="zoomLevel2" style="padding:0 8px;height:30px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:11px;display:flex;align-items:center;">100%</div>
      <button class="zoom-btn" id="zoomIn2" data-tip="ØªÙƒØ¨ÙŠØ±">+</button>
      <button class="zoom-btn" id="zoomFit2" data-tip="Ù…Ù„Ø§Ø¡Ù…Ø©" style="font-size:12px;">âŠ¡</button>
    </div>

    <!-- Floating tool bar â€” INSIDE canvasArea so position:absolute works -->
    <div id="leftPanel">
      <button class="tool-btn active" data-tool="draw" data-tip="Ø±Ø³Ù… (B)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      </button>
      <button class="tool-btn" data-tool="erase" data-tip="Ù…Ù…Ø­Ø§Ø© (E)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 20H7L3 16l10-10 7 7-3.5 3.5"/><path d="M6.5 17.5l4-4"/></svg>
      </button>
      <button class="tool-btn" data-tool="fill" data-tip="Ù…Ù„Ø¡ (F)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M19 11L9 1 3 7l10 10"/><path d="M9.5 21.5a2.5 2.5 0 0 1-5 0c0-1.38 2.5-5 2.5-5s2.5 3.62 2.5 5z"/></svg>
      </button>
      <button class="tool-btn" data-tool="pan" data-tip="ØªØ­Ø±ÙŠÙƒ (H)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>
      </button>
      <div class="tool-sep"></div>
      <!-- Color button: shows current color, click opens dropdown -->
      <div id="colorDropWrap" style="position:relative;">
        <div id="colorDropBtn" data-tip="Ø§Ø®ØªØ± Ù„ÙˆÙ†Ø§Ù‹"
          style="width:32px;height:32px;border-radius:9px;border:2px solid rgba(255,255,255,0.25);overflow:hidden;cursor:pointer;flex-shrink:0;position:relative;">
          <div id="colorPreview" style="width:100%;height:100%;background:#F5A623;"></div>
          <input type="color" id="quickColor" value="#F5A623" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;"/>
        </div>
        <!-- Dropdown panel -->
        <div id="colorDropdown">
          <div id="floatSwatches"></div>
          <div style="height:1px;background:rgba(255,255,255,0.08);margin:4px 0;"></div>
          <div data-tip="Ù„ÙˆÙ† Ù…Ø®ØµØµ"
            style="width:26px;height:26px;border-radius:8px;background:conic-gradient(red,yellow,lime,cyan,blue,magenta,red);cursor:pointer;border:2px solid transparent;flex-shrink:0;"
            onclick="document.getElementById('quickColor').click()">
          </div>
        </div>
      </div>
      <div id="bgScaleControls" style="display:none;flex-direction:column;gap:3px;">
        <button class="tool-btn" id="bgScaleDown" data-tip="ØªØµØºÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©">âˆ’</button>
        <button class="tool-btn" id="bgScaleUp" data-tip="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©">+</button>
      </div>
    </div>
  </div>

  <!-- Right panel REMOVED â€” content moved to bottom sheet via JS -->
  <!-- Hidden container holding all tab pane HTML -->
  <div id="tabPanesStore" style="display:none">

    <!-- TOOLS -->
    <div id="tab-tools" class="tab-pane">
      <div class="sec">Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ù…</div>
      <div class="ctrl-row">
        <div class="color-btn"><input type="color" id="fillColor" value="#F5A623"/></div>
        <span class="ctrl-label">Ù„ÙˆÙ† Ø§Ù„Ø­Ø´Ùˆ</span>
      </div>
      <div class="ctrl-row">
        <div class="color-btn"><input type="color" id="bgColor" value="#0D1017"/></div>
        <span class="ctrl-label">Ù„ÙˆÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø±ØºØ©</span>
      </div>
      <div class="sec" style="margin-top:8px;display:flex;align-items:center;justify-content:space-between;">
        <span>Ø£Ù„ÙˆØ§Ù† Ø³Ø±ÙŠØ¹Ø©</span>
        <div style="display:flex;gap:4px;align-items:center;">
          <button class="lib-icon-btn" id="btnAddSwatch" title="Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ø¬Ø¯ÙŠØ¯" style="width:22px;height:22px;font-size:14px;padding:0;">+</button>
          <input type="color" id="newSwatchColor" style="opacity:0;width:0;height:0;position:absolute;pointer-events:none;"/>
        </div>
      </div>
      <div class="swatches" id="swatchesContainer">
        <div class="swatch selected" style="background:#7C3AED" data-color="#7C3AED"></div>
        <div class="swatch" style="background:#A855F7" data-color="#A855F7"></div>
        <div class="swatch" style="background:#EF4444" data-color="#EF4444"></div>
        <div class="swatch" style="background:#22C55E" data-color="#22C55E"></div>
        <div class="swatch" style="background:#3B82F6" data-color="#3B82F6"></div>
        <div class="swatch" style="background:#EC4899" data-color="#EC4899"></div>
        <div class="swatch" style="background:#14B8A6" data-color="#14B8A6"></div>
        <div class="swatch" style="background:#F5A623" data-color="#F5A623"></div>
        <div class="swatch" style="background:#FFFFFF" data-color="#FFFFFF"></div>
        <div class="swatch" style="background:#111827;border:1px solid #333" data-color="#111827"></div>
      </div>
      <div class="sec" style="margin-top:8px;">ØªØµØ¯ÙŠØ±</div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <button class="s-btn accent full" id="exportPNG">ØªØµØ¯ÙŠØ± PNG Ù†Ø¸ÙŠÙ</button>
        <button class="s-btn full" id="exportWithBg">ØªØµØ¯ÙŠØ± Ù…Ø¹ Ø®Ù„ÙÙŠØ©</button>
      </div>
      <div class="sec" style="margin-top:8px;">Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø©</div>
      <div class="btn-group">
        <button class="s-btn" id="canvasDark">Ø¯Ø§ÙƒÙ†Ø©</button>
        <button class="s-btn" id="canvasLight">ÙØ§ØªØ­Ø©</button>
        <div class="color-btn" style="width:30px;height:30px;"><input type="color" id="canvasBgColor" value="#0A0C10"/></div>
      </div>
    </div>

    <!-- GRID -->
    <div id="tab-grid" class="tab-pane">
      <div class="sec">Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ©</div>
      <div class="size-grid">
        <div><div style="font-size:10px;color:var(--muted);text-align:center;margin-bottom:4px;">Ø£Ø¹Ù…Ø¯Ø©</div><input type="number" id="gridCols" value="24" min="5" max="120"/></div>
        <div><div style="font-size:10px;color:var(--muted);text-align:center;margin-bottom:4px;">ØµÙÙˆÙ</div><input type="number" id="gridRows" value="24" min="5" max="120"/></div>
      </div>
      <button class="s-btn accent full" id="applyGridSize" style="margin-top:6px;">ØªØ·Ø¨ÙŠÙ‚</button>
      <div class="sec" style="margin-top:8px;">Ù‚ÙˆØ§Ù„Ø¨ Ø³Ø±ÙŠØ¹Ø©</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
        <button class="s-btn" data-preset="16,16">16Ã—16</button>
        <button class="s-btn" data-preset="24,24">24Ã—24</button>
        <button class="s-btn" data-preset="32,24">32Ã—24</button>
        <button class="s-btn" data-preset="40,40">40Ã—40</button>
        <button class="s-btn" data-preset="48,32">48Ã—32</button>
        <button class="s-btn" data-preset="64,48">64Ã—48</button>
      </div>
      <div class="sec" style="margin-top:8px;">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ©</div>
      <div class="ctrl-row"><input type="range" id="cellSizeR" min="10" max="80" value="30"/><span class="ctrl-val" id="cellSizeVal">30</span></div>
      <div class="sec">ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§</div>
      <div class="ctrl-row"><input type="range" id="gapSizeR" min="0" max="30" value="15"/><span class="ctrl-val" id="gapSizeVal">15</span></div>
      <div class="sec">Ø§Ø³ØªØ¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ÙƒØ§Ù†</div>
      <div class="ctrl-row"><input type="range" id="cellRadR" min="0" max="20" value="5"/><span class="ctrl-val" id="cellRadVal">5</span></div>
      <div class="sec" style="margin-top:8px;">Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø­Ø§ÙˆØ±</div>
      <div class="ctrl-row"><input type="checkbox" id="showAxis" checked style="width:15px;height:15px;"/><span class="ctrl-label">Ø¥Ø¸Ù‡Ø§Ø± Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø­Ø§ÙˆØ±</span></div>
      <div class="ctrl-row">
        <div class="color-btn"><input type="color" id="axisColor" value="#7f0000"/></div>
        <span class="ctrl-label">Ù„ÙˆÙ† Ø§Ù„Ù…Ø­ÙˆØ±</span>
      </div>
      <div class="ctrl-row"><span class="ctrl-label">ÙƒÙ„</span><input type="range" id="axisEveryR" min="2" max="20" value="5"/><span class="ctrl-val" id="axisEveryVal">5</span><span class="ctrl-label">Ø®Ù„ÙŠØ©</span></div>
      <div class="sec" style="margin-top:8px;">Ù…Ø³Ø§Ø·Ø± Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯</div>
      <div class="ctrl-row"><input type="checkbox" id="showRulers" style="width:15px;height:15px;"/><span class="ctrl-label">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø·Ø± Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡</span></div>
      <div class="sec" style="margin-top:8px;">Ø®Ø·ÙˆØ· Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§</div>
      <div class="ctrl-row"><input type="checkbox" id="showLineMode" style="width:15px;height:15px;"/><span class="ctrl-label">ØªÙØ¹ÙŠÙ„ Ø±Ø³Ù… Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø¨ÙŠÙ†ÙŠØ©</span></div>
    </div>

    <!-- LETTERS -->
    <div id="tab-letters" class="tab-pane">
      <div id="libHeader">
        <input type="text" id="libSearch" placeholder="Ø¨Ø­Ø«..."/>
        <button class="lib-icon-btn" id="btnAddLetter" title="Ø­Ø±Ù Ø¬Ø¯ÙŠØ¯">+</button>
        <button class="lib-icon-btn" id="btnExportLib" title="ØªØµØ¯ÙŠØ± JSON">â†‘</button>
        <button class="lib-icon-btn" id="btnImportLib" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON">â†“</button>
        <button class="lib-icon-btn" id="btnResetLib" title="Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ" style="color:#ef4444;">â†º</button>
        <input type="file" id="importLibFile" accept=".json" style="display:none"/>
      </div>
      <div id="letterLibrary"></div>
      <div class="sec" style="margin-top:10px;">Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬</div>
      <div class="ctrl-row">
        <span class="ctrl-label">X</span><input type="number" id="placeX" value="2" min="0" max="90" style="flex:1"/>
        <span class="ctrl-label">Y</span><input type="number" id="placeY" value="2" min="0" max="90" style="flex:1"/>
      </div>
      <div class="ctrl-row"><input type="checkbox" id="autoAdvance" checked style="width:15px;height:15px;"/><span class="ctrl-label">ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙ…ÙŠÙ†Ø§Ù‹</span></div>
    </div>

    <!-- BACKGROUND -->
    <div id="tab-bg" class="tab-pane">
      <div class="sec">ØµÙˆØ±Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ù„Ù„Ù†Ø³Ø®</div>
      <label class="upload-zone" for="bgFileInput">
        <div style="font-size:22px;margin-bottom:5px;">ğŸ“·</div>
        <div>Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©</div>
        <div style="font-size:10px;margin-top:3px;">PNG, JPG, SVG, WebP</div>
        <input type="file" id="bgFileInput" accept="image/*"/>
      </label>
      <div id="bgControls" style="display:none;margin-top:8px;display:flex;flex-direction:column;gap:8px;">
        <div>
          <div class="sec">Ø§Ù„Ø´ÙØ§ÙÙŠØ©</div>
          <div class="ctrl-row"><input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.35"/><span class="ctrl-val" id="bgOpacityVal">35%</span></div>
        </div>
        <div>
          <div class="sec">Ø§Ù„Ø­Ø¬Ù…</div>
          <div class="ctrl-row"><input type="range" id="bgScale" min="10" max="300" value="100"/><span class="ctrl-val" id="bgScaleVal">100%</span></div>
        </div>
        <div>
          <div class="sec">Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙÙ‚ÙŠ (X)</div>
          <div class="ctrl-row"><input type="range" id="bgX" min="-600" max="600" value="0"/><span class="ctrl-val" id="bgXVal">0</span></div>
        </div>
        <div>
          <div class="sec">Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ (Y)</div>
          <div class="ctrl-row"><input type="range" id="bgY" min="-600" max="600" value="0"/><span class="ctrl-val" id="bgYVal">0</span></div>
        </div>
        <div>
          <div class="sec">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø²Ø¬</div>
          <select id="bgBlendMode" style="width:100%;background:var(--surface3);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:var(--rs);font-family:'Tajawal',sans-serif;font-size:12px;outline:none;">
            <option value="normal">Ø¹Ø§Ø¯ÙŠ</option>
            <option value="multiply">Ø¶Ø±Ø¨</option>
            <option value="screen">Ø´Ø§Ø´Ø©</option>
            <option value="overlay">ØªØ±Ø§ÙƒØ¨</option>
            <option value="lighten">Ø¥Ø¶Ø§Ø¡Ø©</option>
          </select>
        </div>
        <div class="ctrl-row"><input type="checkbox" id="bgDraggable" style="width:15px;height:15px;"/><span class="ctrl-label">ØªÙ…ÙƒÙŠÙ† Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙŠØ¯</span></div>
        <div class="btn-group">
          <button class="s-btn" id="bgToggle" style="flex:1">Ø¥Ø®ÙØ§Ø¡</button>
          <button class="s-btn" id="bgReset" style="flex:1">Ù…Ø±ÙƒØ²</button>
          <button class="s-btn danger" id="bgRemove" style="flex:1">Ø¥Ø²Ø§Ù„Ø©</button>
        </div>
      </div>
    </div>

    <!-- ABOUT -->
    <div id="tab-about" class="tab-pane">
      <!-- Profile card -->
      <div style="display:flex;flex-direction:column;align-items:center;padding:20px 16px 12px;gap:12px;">
        <div style="width:80px;height:80px;border-radius:22px;overflow:hidden;box-shadow:0 4px 24px rgba(245,166,35,0.45);flex-shrink:0;">
          <img src="icons/icon-192.png" alt="kufiMaker" style="width:100%;height:100%;object-fit:cover;display:block;"/>
        </div>
        <div style="text-align:center;">
          <div style="font-size:18px;font-weight:800;color:var(--text);letter-spacing:-.5px;">kufiMaker</div>
          <div style="font-size:12px;color:var(--muted);margin-top:3px;">Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹</div>
        </div>
      </div>

      <!-- App description -->
      <div style="background:var(--surface2);border-radius:var(--r);padding:14px 16px;margin:0 4px;border:1px solid var(--border);">
        <div style="font-size:12px;color:var(--muted);line-height:1.8;text-align:center;">
          Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© ÙˆÙ…ÙØªÙˆØ­Ø© Ø§Ù„Ù…ØµØ¯Ø± Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ø· Ø§Ù„ÙƒÙˆÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹.<br/>
          ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ â€” Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù… Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§ØµØ©.
        </div>
      </div>

      <!-- Developer -->
      <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border-radius:var(--r);border:1px solid var(--border);margin:8px 4px 0;">
        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">ğŸ‘¨â€ğŸ’»</div>
        <div>
          <div style="font-size:14px;font-weight:700;">ab7dz</div>
          <div style="font-size:11px;color:var(--muted);">Ù…Ù† ØªØ·ÙˆÙŠØ± Ø­Ø³Ù†Ø§ÙˆÙŠ Ù…Ù† Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± ÙˆÙ…Ø³Ø§Ø¹Ø¯Ø© CL46</div>
          <div style="font-size:12px;color:var(--accent);font-weight:500;">hasAyou@gmail.com</div>
        </div>
      </div>

      <!-- Links -->
      <div style="display:flex;flex-direction:column;gap:6px;margin:8px 4px 0;">
        <a href="https://github.com/ab7dz/kufiMaker" target="_blank" rel="noopener"
          style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border-radius:var(--r);border:1px solid var(--border);color:var(--text);text-decoration:none;font-size:13px;transition:border-color .15s;"
          onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;"><path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0 1 12 6.844a9.59 9.59 0 0 1 2.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.745 0 .268.18.58.688.482A10.02 10.02 0 0 0 22 12.017C22 6.484 17.522 2 12 2z"/></svg>
          <div style="flex:1;">
            <div style="font-weight:600;">Ø§Ù„Ù…ØµØ¯Ø± Ø¹Ù„Ù‰ GitHub</div>
            <div style="font-size:11px;color:var(--muted);">ab7dz/kufiMaker</div>
          </div>
          <svg style="opacity:.4" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        </a>
      </div>

      <!-- Version -->
      <div style="text-align:center;padding:16px 0 8px;font-size:11px;color:var(--muted);">
        kufiMaker v7 &nbsp;Â·&nbsp; MIT License &nbsp;Â·&nbsp; 2026
      </div>
    </div>

  </div><!-- /tabPanesStore -->

</div><!-- /main -->

<!-- STATUS BAR -->
<div id="statusBar">
  <span>Ø§Ù„Ø£Ø¯Ø§Ø©: <b id="statusTool">Ø±Ø³Ù…</b></span>
  <span>Ø§Ù„Ø´Ø¨ÙƒØ©: <b id="statusGrid">32Ã—24</b></span>
  <span>Ù…Ù…Ù„ÙˆØ¡: <b id="statusFilled">0</b></span>
  <span>X:<b id="statusX">â€”</b> Y:<b id="statusY">â€”</b></span>
</div>

<!-- MODAL -->
<div id="modalOverlay">
  <div id="modal">
    <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯</h3>
    <p id="modalMsg"></p>
    <div class="modal-btns">
      <button class="s-btn accent" style="flex:1" id="modalOk">Ù…ÙˆØ§ÙÙ‚</button>
      <button class="s-btn" style="flex:1" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- LETTER EDITOR MODAL -->
<div id="letterEditorModal">
  <div class="le-panel">
    <div class="le-title">
      <span id="leModalTitle">Ø­Ø±Ù Ø¬Ø¯ÙŠØ¯</span>
      <span class="le-close" id="leClose">âœ•</span>
    </div>
    <div class="le-fields">
      <div class="le-field">
        <label>Ø§Ù„Ø­Ø±Ù / Ø§Ù„Ø±Ù…Ø²</label>
        <input type="text" id="leChar" placeholder="Ù…Ø«Ù„: Ù†" maxlength="4"/>
      </div>
      <div class="le-field">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="leName" placeholder="Ù…Ø«Ù„: Ù†ÙˆÙ†"/>
      </div>
    </div>
    <div class="le-grid-controls">
      <span style="font-size:11px;color:var(--muted);">Ø§Ù„Ø´Ø¨ÙƒØ©:</span>
      <input type="number" id="leGridW" value="5" min="1" max="20"/> Ã— 
      <input type="number" id="leGridH" value="5" min="1" max="20"/>
      <button class="le-btn" id="leResizeBtn" style="flex:none;padding:4px 10px;font-size:11px;">ØªØ·Ø¨ÙŠÙ‚</button>
      <button class="le-btn" id="leClearBtn" style="flex:none;padding:4px 10px;font-size:11px;">Ù…Ø³Ø­</button>
    </div>
    <div style="display:flex;gap:5px;align-items:center;margin-bottom:2px;">
      <span style="font-size:10px;color:var(--muted);">Ø£Ø¯Ø§Ø©:</span>
      <button class="le-tool-btn active" id="leToolDraw" data-letool="draw">âœï¸ Ø±Ø³Ù…</button>
      <button class="le-tool-btn" id="leToolErase" data-letool="erase">ğŸ§¹ Ù…Ø³Ø­</button>
    </div>
    <div class="le-editor-wrap">
      <div id="leEditorGrid" class="le-editor-grid"></div>
    </div>
    <div class="le-actions">
      <button class="le-btn danger" id="leDeleteBtn" style="display:none;">Ø­Ø°Ù</button>
      <button class="le-btn" id="leCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="le-btn primary" id="leSaveBtn">Ø­ÙØ¸ Ø§Ù„Ø­Ø±Ù</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   kufiMaker â€” v7
   âœ“ Blend mode FIXED (bgLayer is sibling of gc, not child)
   âœ“ Gap H/V/Dot cells fully interactive like cells
   âœ“ Smart corner radius (connected shapes look joined)
   âœ“ Default: 24Ã—24, cellSz=30, gap=15, rad=5
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â• */
let cols=24, rows=24;
let grid=[], gapH=[], gapV=[], gapD=[];
let cellColors={}, gapHColors={}, gapVColors={}, gapDColors={};
let history=[], redoStack=[];
let tool='draw', drawColor='#F5A623';
let isDrawing=false, lastX=-1, lastY=-1;
let gapDrawing=false;
let bgImg=null, bgVisible=true, bgDragEnable=false;
let bgProps={x:0, y:0, w:0, h:0, opacity:0.5, blend:'normal', rotate:0};
let cellSz=30, gapSz=15, cellRad=5;
let axisEvery=5, showAxis=true, axisColor='#7f0000';
let zoom=1;
let panActive=false, panStart={};
let showRulers=false;
let blocks=[], blockCounter=0;

const gc  = document.getElementById('gridCanvas');
const bgL = document.getElementById('bgLayer');
const vp  = document.getElementById('canvasViewport');
const coordsBar = document.getElementById('coordsBar');
const rulerH = document.getElementById('rulerH');
const rulerV = document.getElementById('rulerV');
function $id(id){return document.getElementById(id);}

/* â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â• */
function computeGridDimensions(){
  const vpW=vp.clientWidth||window.innerWidth-48;
  const vpH=vp.clientHeight||window.innerHeight-76;
  return{
    c:Math.max(5,Math.floor((vpW-40)/(cellSz+gapSz))),
    r:Math.max(5,Math.floor((vpH-40)/(cellSz+gapSz)))
  };
}

function initGrid(c,r){
  if(c==null){const d=computeGridDimensions();c=d.c;r=d.r;}
  document.querySelectorAll('.block-overlay').forEach(e=>e.remove());
  blocks=[];
  gc.innerHTML='';
  cols=c; rows=r;
  $id('gridCols').value=cols; $id('gridRows').value=rows;
  document.documentElement.style.setProperty('--cell-size',cellSz+'px');
  document.documentElement.style.setProperty('--gap',gapSz+'px');

  gc.style.cssText=`
    display:inline-grid;
    grid-template-columns:repeat(${cols},${cellSz}px);
    gap:${gapSz}px; padding:20px;
    position:relative; min-width:max-content;
    transform-origin:top left; transform:scale(${zoom});
  `;

  // Data arrays
  grid  = Array.from({length:r}, ()=>Array(c).fill(0));
  gapH  = Array.from({length:r-1}, ()=>Array(c).fill(0));   // between rows
  gapV  = Array.from({length:r},   ()=>Array(c-1).fill(0)); // between cols
  gapD  = Array.from({length:r-1}, ()=>Array(c-1).fill(0)); // corner dots
  cellColors={}; gapHColors={}; gapVColors={}; gapDColors={};

  // Cell elements
  for(let y=0;y<r;y++) for(let x=0;x<c;x++){
    const el=document.createElement('div');
    el.className='cell'; el.dataset.x=x; el.dataset.y=y;
    el.style.borderRadius=`${cellRad}px`;
    el.style.width=el.style.height=`${cellSz}px`;
    gc.appendChild(el);
  }

  drawAxisLines();
  renderGapElements();
  updateStatus();
  $id('statusGrid').textContent=`${cols}Ã—${rows}`;
}

let resizeTimer=null;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(()=>{if(!grid.flat().some(v=>v))initGrid();},300);
});
// Fix landscape scroll: force viewport reflow on orientation change
window.addEventListener('orientationchange',()=>{
  setTimeout(()=>{
    // Force viewport to recalculate its scroll dimensions
    vp.style.display='none';
    vp.offsetHeight; // trigger reflow
    vp.style.display='';
  }, 300);
});

function cellEl(x,y){return gc.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`)||null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART RADIUS â€” final correct model
   
   Grid layout (T = cellSz+gapSz):
     cell(x,y) â”‚ gapV(x,y) â”‚ cell(x+1,y)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     gapH(x,y) â”‚ gapD(x,y) â”‚ gapH(x+1,y)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     cell(x,y+1)â”‚gapV(x,y+1)â”‚cell(x+1,y+1)

   RULE: A corner of any element is SQUARE when the corner "slot" of the
   diagonal neighbour (gapD) is filled, OR when BOTH arms extending from
   that corner in the two orthogonal directions are occupied.

   For cell(x,y) BR corner:
     Square if:  gapD(x,y) filled
              OR (right-arm: gapV(x,y) or cell(x+1,y)) AND (below-arm: gapH(x,y) or cell(x,y+1))
              OR right-arm filled alone  [shares full right edge]
              OR below-arm filled alone  [shares full bottom edge]

   Wait â€” simpler: corner is square if EITHER arm is filled (since sharing an edge
   means the corner point is shared). So:
     BR square if: (gapV(x,y) or cell(x+1,y)) OR (gapH(x,y) or cell(x,y+1)) OR gapD(x,y)

   This is correct. The look-through-diagonal extra conditions I had before
   were for cases like: gapV to right is filled AND gapH below-right is filled.
   But gapH(x+1,y) is not adjacent to cell(x,y) at all â€” it's too far.
   So the extra conditions were WRONG and were causing phantom squaring.

   FINAL SIMPLE CORRECT FORMULA:
   cell(x,y) corner is square iff any element that DIRECTLY SHARES THAT CORNER POINT is filled.
   
   Directly shares corner point means: shares an edge (â†’ all edge corners) or corner only.
   
   cell BR shares its BR corner with:
     - gapV(x,y)   [shares right edge â†’ shares BR point]
     - cell(x+1,y) [separated by gapV â†’ does NOT directly share corner]
     - gapH(x,y)   [shares bottom edge â†’ shares BR point]  
     - cell(x,y+1) [separated by gapH â†’ does NOT directly share corner]
     - gapD(x,y)   [shares only the corner point diagonally]

   Wait, but if there's NO gapV between cell(x,y) and cell(x+1,y), they ARE adjacent?
   NO â€” in our grid there is ALWAYS a gapV slot between horizontally adjacent cells,
   and ALWAYS a gapH slot between vertically adjacent cells.
   The gap slots exist even when empty (value=0).

   So cell(x,y) NEVER directly touches cell(x+1,y) â€” there is always a gapV slot between them.
   cell(x,y) directly touches: gapV(x,y) on the right, gapH(x,y) below,
                                gapV(x-1,y) on the left, gapH(x,y-1) above,
                                gapD(x-1,y-1) at TL corner, gapD(x,y-1) at TR,
                                gapD(x-1,y) at BL, gapD(x,y) at BR.
   
   That's it. Cells never directly touch other cells.

   CORRECT FINAL FORMULAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isFC(x,y){return x>=0&&x<cols&&y>=0&&y<rows&&grid[y][x]===1;}
function isGH(gx,gy){return gy>=0&&gy<rows-1&&gx>=0&&gx<cols&&gapH[gy][gx]===1;}
function isGV(gx,gy){return gy>=0&&gy<rows&&gx>=0&&gx<cols-1&&gapV[gy][gx]===1;}
function isGD(gx,gy){return gy>=0&&gy<rows-1&&gx>=0&&gx<cols-1&&gapD[gy][gx]===1;}
function rc(b){return(b||cellRad===0)?0:cellRad;}

/* CELL(x,y): touches only its 4 gap-edge neighbours and 4 gapD corner neighbours */
function computeCellRadius(x,y){
  if(cellRad===0) return '0';
  const tl=rc(isGV(x-1,y)||isGH(x,y-1)||isGD(x-1,y-1));
  const tr=rc(isGV(x,  y)||isGH(x,y-1)||isGD(x,  y-1));
  const bl=rc(isGV(x-1,y)||isGH(x,y  )||isGD(x-1,y  ));
  const br=rc(isGV(x,  y)||isGH(x,y  )||isGD(x,  y  ));
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

/* GAPH(gx,gy): bar between row gy (above) and row gy+1 (below)
   Direct neighbours: cell(gx,gy)[above edge], cell(gx,gy+1)[below edge],
                      gapV(gx-1,gy)[left-top edge], gapV(gx-1,gy+1)[left-bottom edge],
                      gapV(gx,gy)[right-top edge],  gapV(gx,gy+1)[right-bottom edge],
                      gapD(gx-1,gy)[left corner], gapD(gx,gy)[right corner]
   TL corner: shared with cell(gx,gy)[above] and gapV(gx-1,gy)[left-top] and gapD(gx-1,gy)
   TR corner: shared with cell(gx,gy) and gapV(gx,gy) and gapD(gx,gy)
   BL corner: shared with cell(gx,gy+1) and gapV(gx-1,gy+1) and gapD(gx-1,gy)
   BR corner: shared with cell(gx,gy+1) and gapV(gx,gy+1) and gapD(gx,gy)
*/
function computeGHRadius(gx,gy){
  if(cellRad===0) return '0';
  const tl=rc(isFC(gx,gy)  ||isGV(gx-1,gy)  ||isGD(gx-1,gy));
  const tr=rc(isFC(gx,gy)  ||isGV(gx,  gy)  ||isGD(gx,  gy));
  const bl=rc(isFC(gx,gy+1)||isGV(gx-1,gy+1)||isGD(gx-1,gy));
  const br=rc(isFC(gx,gy+1)||isGV(gx,  gy+1)||isGD(gx,  gy));
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

/* GAPV(gx,gy): bar between col gx (left) and col gx+1 (right)
   TL corner: shared with cell(gx,gy)[left] and gapH(gx,gy-1)[top-left] and gapD(gx,gy-1)
   TR corner: shared with cell(gx+1,gy)[right] and gapH(gx+1,gy-1)[top-right] and gapD(gx,gy-1)
   BL corner: shared with cell(gx,gy)[left] and gapH(gx,gy)[bottom-left] and gapD(gx,gy)
   BR corner: shared with cell(gx+1,gy)[right] and gapH(gx+1,gy)[bottom-right] and gapD(gx,gy)
*/
function computeGVRadius(gx,gy){
  if(cellRad===0) return '0';
  const tl=rc(isFC(gx,  gy)||isGH(gx,  gy-1)||isGD(gx,gy-1));
  const tr=rc(isFC(gx+1,gy)||isGH(gx+1,gy-1)||isGD(gx,gy-1));
  const bl=rc(isFC(gx,  gy)||isGH(gx,  gy)  ||isGD(gx,gy));
  const br=rc(isFC(gx+1,gy)||isGH(gx+1,gy)  ||isGD(gx,gy));
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

/* GAPD(gx,gy): corner dot â€” directly touches 1 cell + 1 gapH + 1 gapV at each corner */
function computeGDRadius(gx,gy){
  if(cellRad===0) return '0';
  const maxR = Math.min(cellRad, Math.floor(gapSz/2));
  const r2 = (b)=>b?0:maxR;
  const tl=r2(isFC(gx,  gy)  ||isGH(gx,  gy)||isGV(gx,gy));
  const tr=r2(isFC(gx+1,gy)  ||isGH(gx+1,gy)||isGV(gx,gy));
  const bl=r2(isFC(gx,  gy+1)||isGH(gx,  gy)||isGV(gx,gy+1));
  const br=r2(isFC(gx+1,gy+1)||isGH(gx+1,gy)||isGV(gx,gy+1));
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

/* â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â•â•â•â• */
function renderGrid(){
  for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
    const el=cellEl(x,y); if(!el) continue;
    const v=grid[y][x];
    el.style.background = v?(cellColors[`${x},${y}`]||drawColor):'';
    el.classList.toggle('filled',!!v);
    el.style.borderRadius = v?computeCellRadius(x,y):`${cellRad}px`;
  }
  renderGapElements();
  updateStatus();
}

function renderGapElements(){
  document.querySelectorAll('.gap-h,.gap-v,.gap-d').forEach(e=>e.remove());
  const total=cellSz+gapSz, pad=20;

  // Horizontal gaps (between rows gy and gy+1)
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols;gx++){
    const v=gapH[gy][gx];
    const el=document.createElement('div');
    el.className='gap-h'+(v?' filled':'');
    el.dataset.gtype='h'; el.dataset.gx=gx; el.dataset.gy=gy;
    const col=v?(gapHColors[`${gx},${gy}`]||drawColor):'rgba(255,255,255,0.05)';
    el.style.cssText=`position:absolute;left:${pad+gx*total}px;top:${pad+(gy+1)*total-gapSz}px;width:${cellSz}px;height:${gapSz}px;background:${col};z-index:4;pointer-events:auto;cursor:crosshair;border-radius:${v?computeGHRadius(gx,gy):'0'};`;
    gc.appendChild(el);
  }

  // Vertical gaps (between cols gx and gx+1)
  for(let gy=0;gy<rows;gy++) for(let gx=0;gx<cols-1;gx++){
    const v=gapV[gy][gx];
    const el=document.createElement('div');
    el.className='gap-v'+(v?' filled':'');
    el.dataset.gtype='v'; el.dataset.gx=gx; el.dataset.gy=gy;
    const col=v?(gapVColors[`${gx},${gy}`]||drawColor):'rgba(255,255,255,0.05)';
    el.style.cssText=`position:absolute;left:${pad+(gx+1)*total-gapSz}px;top:${pad+gy*total}px;width:${gapSz}px;height:${cellSz}px;background:${col};z-index:4;pointer-events:auto;cursor:crosshair;border-radius:${v?computeGVRadius(gx,gy):'0'};`;
    gc.appendChild(el);
  }

  // Corner dots at intersections
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols-1;gx++){
    const v=gapD[gy][gx];
    const el=document.createElement('div');
    el.className='gap-d'+(v?' filled':'');
    el.dataset.gtype='d'; el.dataset.gx=gx; el.dataset.gy=gy;
    const col=v?(gapDColors[`${gx},${gy}`]||drawColor):'rgba(255,255,255,0.03)';
    el.style.cssText=`position:absolute;left:${pad+(gx+1)*total-gapSz}px;top:${pad+(gy+1)*total-gapSz}px;width:${gapSz}px;height:${gapSz}px;background:${col};z-index:5;pointer-events:auto;cursor:crosshair;border-radius:${v?computeGDRadius(gx,gy):'0'};`;
    gc.appendChild(el);
  }
}

function refreshRadiusAround(x,y){
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx,ny=y+dy;
    if(nx<0||nx>=cols||ny<0||ny>=rows) continue;
    const el=cellEl(nx,ny); if(!el) continue;
    el.style.borderRadius=grid[ny][nx]?computeCellRadius(nx,ny):`${cellRad}px`;
  }
}
function refreshAllRadius(){
  for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
    const el=cellEl(x,y); if(!el) continue;
    el.style.borderRadius=grid[y][x]?computeCellRadius(x,y):`${cellRad}px`;
  }
}

/* â•â•â•â•â•â•â•â•â•â• AXIS LINES â•â•â•â•â•â•â•â•â•â• */
function drawAxisLines(){
  document.querySelectorAll('.axis-h,.axis-v').forEach(e=>e.remove());
  if(!showAxis) return;
  const total=cellSz+gapSz, pad=20;
  for(let x=axisEvery;x<cols;x+=axisEvery){
    const el=document.createElement('div'); el.className='axis-v';
    el.style.cssText=`left:${pad+x*total-1}px;top:${pad}px;width:1px;height:${rows*total}px;background:${axisColor};position:absolute;pointer-events:none;z-index:3;`;
    gc.appendChild(el);
  }
  for(let y=axisEvery;y<rows;y+=axisEvery){
    const el=document.createElement('div'); el.className='axis-h';
    el.style.cssText=`top:${pad+y*total-1}px;left:${pad}px;height:1px;width:${cols*total}px;background:${axisColor};position:absolute;pointer-events:none;z-index:3;`;
    gc.appendChild(el);
  }
}
function updateStatus(){$id('statusFilled').textContent=grid.flat().filter(v=>v).length;}

/* â•â•â•â•â•â•â•â•â•â• UNDO/REDO â•â•â•â•â•â•â•â•â•â• */
function snap(){
  return{
    g:grid.map(r=>[...r]),
    gH:gapH.map(r=>[...r]),
    gV:gapV.map(r=>[...r]),
    gD:gapD.map(r=>[...r]),
    cc:{...cellColors},ch:{...gapHColors},cv:{...gapVColors},cd:{...gapDColors}
  };
}
function applySnap(s){
  grid=s.g; gapH=s.gH; gapV=s.gV; gapD=s.gD;
  cellColors=s.cc; gapHColors=s.ch; gapVColors=s.cv; gapDColors=s.cd;
}
function saveState(){history.push(snap());if(history.length>60)history.shift();redoStack=[];}
function undo(){if(!history.length)return;redoStack.push(snap());applySnap(history.pop());renderGrid();}
function redo(){if(!redoStack.length)return;history.push(snap());applySnap(redoStack.pop());renderGrid();}

/* â•â•â•â•â•â•â•â•â•â• COORDS â•â•â•â•â•â•â•â•â•â• */
function getCell(e){
  const rect=gc.getBoundingClientRect();
  const px=(e.clientX-rect.left)/zoom, py=(e.clientY-rect.top)/zoom;
  const pad=20, total=cellSz+gapSz;
  const x=Math.floor((px-pad)/total), y=Math.floor((py-pad)/total);
  if(x<0||y<0||x>=cols||y>=rows) return null;
  return{x,y};
}

/* â•â•â•â•â•â•â•â•â•â• DRAWING â•â•â•â•â•â•â•â•â•â• */
function applyTool(x,y,fresh=false){
  if(x<0||y<0||x>=cols||y>=rows) return;
  const el=cellEl(x,y); if(!el) return;
  if(tool==='draw'){
    if(fresh){
      const nv=grid[y][x]===1?0:1; grid[y][x]=nv;
      if(nv){cellColors[`${x},${y}`]=drawColor;el.classList.add('filled');el.style.background=drawColor;}
      else  {delete cellColors[`${x},${y}`];el.classList.remove('filled');el.style.background='';}
    } else {
      if(grid[y][x]===1) return;
      grid[y][x]=1; cellColors[`${x},${y}`]=drawColor;
      el.classList.add('filled'); el.style.background=drawColor;
    }
    el.style.borderRadius=grid[y][x]?computeCellRadius(x,y):`${cellRad}px`;
    refreshRadiusAround(x,y);
    renderGapElements();
  } else if(tool==='erase'){
    if(grid[y][x]===0) return;
    grid[y][x]=0; delete cellColors[`${x},${y}`];
    el.classList.remove('filled'); el.style.background=''; el.style.borderRadius=`${cellRad}px`;
    refreshRadiusAround(x,y);
    renderGapElements();
  }
  updateStatus();
}

function applyGapTool(gt,gx,gy,toggle=false){
  const erase = tool==='erase';
  if(gt==='h'){
    // toggle: if already filled AND draw tool â†’ erase it; else fill
    const cur=gapH[gy][gx];
    const newVal = erase ? 0 : (toggle && cur===1) ? 0 : 1;
    gapH[gy][gx]=newVal;
    if(newVal) gapHColors[`${gx},${gy}`]=drawColor;
    else delete gapHColors[`${gx},${gy}`];
  } else if(gt==='v'){
    const cur=gapV[gy][gx];
    const newVal = erase ? 0 : (toggle && cur===1) ? 0 : 1;
    gapV[gy][gx]=newVal;
    if(newVal) gapVColors[`${gx},${gy}`]=drawColor;
    else delete gapVColors[`${gx},${gy}`];
  } else if(gt==='d'){
    const cur=gapD[gy][gx];
    const newVal = erase ? 0 : (toggle && cur===1) ? 0 : 1;
    gapD[gy][gx]=newVal;
    if(newVal) gapDColors[`${gx},${gy}`]=drawColor;
    else delete gapDColors[`${gx},${gy}`];
  }
  renderGapElements();
  refreshAllRadius();
}

function floodFill(sx,sy){
  const target=grid[sy][sx], rep=target===1?0:1;
  if(target===rep) return;
  saveState();
  const visited=new Set(), stack=[{x:sx,y:sy}];
  while(stack.length){
    const{x,y}=stack.pop(); const k=`${x},${y}`;
    if(visited.has(k)||x<0||y<0||x>=cols||y>=rows||grid[y][x]!==target) continue;
    visited.add(k); grid[y][x]=rep;
    const el=cellEl(x,y);
    if(el){
      if(rep===1){cellColors[`${x},${y}`]=drawColor;el.classList.add('filled');el.style.background=drawColor;}
      else{delete cellColors[`${x},${y}`];el.classList.remove('filled');el.style.background='';}
    }
    stack.push({x:x+1,y},{x:x-1,y},{x,y:y+1},{x,y:y-1});
  }
  refreshAllRadius();
  renderGapElements();
  updateStatus();
}

/* â•â•â•â•â•â•â•â•â•â• POINTER EVENTS â•â•â•â•â•â•â•â•â•â• */
vp.addEventListener('pointerdown',e=>{
  if(tool==='pan'){
    panActive=true;
    panStart={mx:e.clientX,my:e.clientY,sx:vp.scrollLeft,sy:vp.scrollTop};
    vp.setPointerCapture(e.pointerId); return;
  }
  if(e.target.closest?.('.block-overlay')) return;

  // Gap element click â€” toggle on first press, fill-only on drag
  const gt=e.target.dataset.gtype;
  if(gt){
    saveState();
    applyGapTool(gt,+e.target.dataset.gx,+e.target.dataset.gy, true); // toggle on first click
    gapDrawing=true;
    vp.setPointerCapture(e.pointerId); return;
  }

  const cell=getCell(e); if(!cell) return;
  if(tool==='fill'){floodFill(cell.x,cell.y);return;}
  isDrawing=true;
  if(tool==='draw'||tool==='erase') saveState();
  vp.setPointerCapture(e.pointerId);
  applyTool(cell.x,cell.y,true);
  lastX=cell.x; lastY=cell.y;
});

vp.addEventListener('pointermove',e=>{
  if(panActive){
    vp.scrollLeft=panStart.sx-(e.clientX-panStart.mx);
    vp.scrollTop=panStart.sy-(e.clientY-panStart.my); return;
  }
  const cell=getCell(e);
  if(cell){
    coordsBar.textContent=`X: ${cell.x} â€” Y: ${cell.y}`;
    $id('statusX').textContent=cell.x; $id('statusY').textContent=cell.y;
  }
  if(gapDrawing){
    const el=document.elementFromPoint(e.clientX,e.clientY);
    if(el&&el.dataset.gtype) applyGapTool(el.dataset.gtype,+el.dataset.gx,+el.dataset.gy);
    return;
  }
  if(!isDrawing||!cell) return;
  if(cell.x===lastX&&cell.y===lastY) return;
  applyTool(cell.x,cell.y,false);
  lastX=cell.x; lastY=cell.y;
});

vp.addEventListener('pointerup',e=>{
  isDrawing=false; panActive=false; gapDrawing=false;
  try{vp.releasePointerCapture(e.pointerId);}catch(err){}
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND â€” BLEND MODE FIX
   
   ROOT CAUSE: gc uses transform:scale() which creates a stacking context.
   Any child element's mix-blend-mode is TRAPPED within gc's stacking context
   and cannot blend with the dark vp background.
   
   FIX: bgLayer stays as a SIBLING of gc inside vp (NOT a child of gc).
   We position it using the gc's bounding rect relative to vp.
   The image's mix-blend-mode now correctly composites against vp background.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyBg(){
  if(!bgImg){bgL.style.display='none';bgL.innerHTML='';return;}

  const pad=20;
  const gridW=cols*(cellSz+gapSz);
  const gridH=rows*(cellSz+gapSz);

  // Default size on first load
  if(!bgProps.w||bgProps.w===0){
    bgProps.w=Math.round(gridW*zoom*0.8);
    bgProps.h=Math.round(gridH*zoom*0.8);
    bgProps.x=Math.round(gridW*0.1);
    bgProps.y=Math.round(gridH*0.1);
  }

  // Position bgLayer to exactly overlay the grid content area
  // gc.getBoundingClientRect() gives screen coords; subtract vp rect + add scroll
  const gcRect=gc.getBoundingClientRect();
  const vpRect=vp.getBoundingClientRect();
  const offLeft = gcRect.left - vpRect.left + vp.scrollLeft + pad*zoom;
  const offTop  = gcRect.top  - vpRect.top  + vp.scrollTop  + pad*zoom;

  bgL.style.cssText=`
    position:absolute;
    left:${offLeft}px; top:${offTop}px;
    width:${gridW*zoom}px; height:${gridH*zoom}px;
    pointer-events:${bgDragEnable?'auto':'none'};
    z-index:2;
    display:${bgVisible?'block':'none'};
    overflow:visible;
  `;

  bgDragEnable ? buildBgFrame() : buildBgStatic();
}

function buildBgStatic(){
  bgL.innerHTML='';
  const imgDiv=document.createElement('div');
  imgDiv.style.cssText=`
    position:absolute;
    left:${bgProps.x*zoom}px; top:${bgProps.y*zoom}px;
    width:${bgProps.w}px; height:${bgProps.h}px;
    background-image:url(${bgImg});
    background-size:100% 100%; background-repeat:no-repeat;
    opacity:${bgProps.opacity};
    mix-blend-mode:${bgProps.blend};
    transform:rotate(${bgProps.rotate}deg); transform-origin:center center;
    pointer-events:none;
  `;
  bgL.appendChild(imgDiv);
}

function buildBgFrame(){
  bgL.innerHTML='';
  const frame=document.createElement('div');
  frame.id='__bgFrame';
  frame.style.cssText=`
    position:absolute;
    left:${bgProps.x*zoom}px; top:${bgProps.y*zoom}px;
    width:${bgProps.w}px; height:${bgProps.h}px;
    box-sizing:border-box;
    border:2px dashed rgba(66,165,245,0.8);
    pointer-events:auto; z-index:11; touch-action:none;
    transform:rotate(${bgProps.rotate}deg); transform-origin:center center;
  `;
  const imgDiv=document.createElement('div');
  imgDiv.style.cssText=`
    position:absolute; inset:0;
    background-image:url(${bgImg});
    background-size:100% 100%; background-repeat:no-repeat;
    opacity:${bgProps.opacity};
    mix-blend-mode:${bgProps.blend};
    pointer-events:none;
  `;
  frame.appendChild(imgDiv);
  const rl=document.createElement('div'); rl.className='rot-line'; frame.appendChild(rl);
  ['tl','tr','bl','br','tm','bm','lm','rm','rot'].forEach(cls=>{
    const h=document.createElement('div'); h.className=`bg-handle ${cls}`; h.dataset.h=cls; frame.appendChild(h);
  });
  bgL.appendChild(frame);
  attachFrameEvents(frame,imgDiv);
}

function attachFrameEvents(frame,imgEl){
  let action=null, start=null;
  function syncFrame(){
    frame.style.left=(bgProps.x*zoom)+'px'; frame.style.top=(bgProps.y*zoom)+'px';
    frame.style.width=bgProps.w+'px'; frame.style.height=bgProps.h+'px';
    frame.style.transform=`rotate(${bgProps.rotate}deg)`;
    imgEl.style.opacity=bgProps.opacity;
    imgEl.style.mixBlendMode=bgProps.blend;
    $id('bgOpacity').value=bgProps.opacity; $id('bgOpacityVal').textContent=Math.round(bgProps.opacity*100)+'%';
    const sc=Math.round(bgProps.w/(cols*(cellSz+gapSz)*zoom)*100);
    $id('bgScale').value=Math.min(300,sc); $id('bgScaleVal').textContent=Math.min(300,sc)+'%';
    $id('bgX').value=Math.round(bgProps.x); $id('bgXVal').textContent=Math.round(bgProps.x);
    $id('bgY').value=Math.round(bgProps.y); $id('bgYVal').textContent=Math.round(bgProps.y);
  }
  frame.addEventListener('pointerdown',e=>{
    e.stopPropagation(); e.preventDefault();
    action=e.target.dataset.h||'move';
    const fr=frame.getBoundingClientRect();
    start={mx:e.clientX,my:e.clientY,x:bgProps.x,y:bgProps.y,w:bgProps.w,h:bgProps.h,rotate:bgProps.rotate,
           startAngle:Math.atan2(e.clientY-(fr.top+fr.height/2),e.clientX-(fr.left+fr.width/2))};
    frame.setPointerCapture(e.pointerId);
  });
  frame.addEventListener('pointermove',e=>{
    if(!action||!start)return; e.stopPropagation(); e.preventDefault();
    const dx=e.clientX-start.mx, dy=e.clientY-start.my, MIN=30;
    if(action==='rot'){
      const fr=frame.getBoundingClientRect();
      const cur=Math.atan2(e.clientY-(fr.top+fr.height/2),e.clientX-(fr.left+fr.width/2));
      bgProps.rotate=start.rotate+(cur-start.startAngle)*(180/Math.PI);
      frame.style.transform=`rotate(${bgProps.rotate}deg)`; return;
    }
    if(action==='move'){
      bgProps.x=start.x+dx/zoom; bgProps.y=start.y+dy/zoom;
      frame.style.left=(bgProps.x*zoom)+'px'; frame.style.top=(bgProps.y*zoom)+'px';
      syncFrame(); return;
    }
    let nx=start.x,ny=start.y,nw=start.w,nh=start.h;
    if(action==='br'){nw=Math.max(MIN,start.w+dx);nh=Math.max(MIN,start.h+dy);}
    else if(action==='bl'){const d=Math.max(MIN,start.w-dx)-start.w;nw+=d;nx-=d/zoom;nh=Math.max(MIN,start.h+dy);}
    else if(action==='tr'){nw=Math.max(MIN,start.w+dx);const d=Math.max(MIN,start.h-dy)-start.h;nh+=d;ny-=d/zoom;}
    else if(action==='tl'){const dw=Math.max(MIN,start.w-dx)-start.w;nw+=dw;nx-=dw/zoom;const dh=Math.max(MIN,start.h-dy)-start.h;nh+=dh;ny-=dh/zoom;}
    else if(action==='rm'){nw=Math.max(MIN,start.w+dx);}
    else if(action==='lm'){const d=Math.max(MIN,start.w-dx)-start.w;nw+=d;nx-=d/zoom;}
    else if(action==='bm'){nh=Math.max(MIN,start.h+dy);}
    else if(action==='tm'){const d=Math.max(MIN,start.h-dy)-start.h;nh+=d;ny-=d/zoom;}
    bgProps.x=nx;bgProps.y=ny;bgProps.w=nw;bgProps.h=nh; syncFrame();
  });
  frame.addEventListener('pointerup',e=>{try{frame.releasePointerCapture(e.pointerId);}catch(err){}action=null;start=null;});
  frame.addEventListener('pointercancel',e=>{try{frame.releasePointerCapture(e.pointerId);}catch(err){}action=null;start=null;});
}

function syncBgControls(){
  $id('bgX').value=Math.round(bgProps.x); $id('bgXVal').textContent=Math.round(bgProps.x);
  $id('bgY').value=Math.round(bgProps.y); $id('bgYVal').textContent=Math.round(bgProps.y);
  const sc=Math.round(bgProps.w/(cols*(cellSz+gapSz)*zoom)*100);
  $id('bgScale').value=Math.min(300,sc); $id('bgScaleVal').textContent=Math.min(300,sc)+'%';
  $id('bgOpacity').value=bgProps.opacity; $id('bgOpacityVal').textContent=Math.round(bgProps.opacity*100)+'%';
}

/* BG controls */
$id('bgFileInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f)return;
  const rd=new FileReader();
  rd.onload=ev=>{
    bgImg=ev.target.result; $id('bgControls').style.display='flex';
    bgProps.w=0; // reset so applyBg auto-sizes
    bgProps.opacity=0.5; bgProps.rotate=0; bgProps.blend='normal';
    bgDragEnable=true; $id('bgDraggable').checked=true;
    applyBg(); syncBgControls();
  };
  rd.readAsDataURL(f);
});
['bgOpacity','bgScale','bgX','bgY'].forEach(id=>{
  $id(id).addEventListener('input',e=>{
    const v=+e.target.value;
    if(id==='bgOpacity'){bgProps.opacity=v;$id('bgOpacityVal').textContent=Math.round(v*100)+'%';}
    else if(id==='bgScale'){
      const gW=cols*(cellSz+gapSz)*zoom;
      const ratio=bgProps.h/Math.max(1,bgProps.w);
      bgProps.w=Math.round(gW*v/100); bgProps.h=Math.round(bgProps.w*ratio);
      $id('bgScaleVal').textContent=v+'%';
    }
    else if(id==='bgX'){bgProps.x=v;$id('bgXVal').textContent=v;}
    else if(id==='bgY'){bgProps.y=v;$id('bgYVal').textContent=v;}
    applyBg();
  });
});
$id('bgBlendMode').addEventListener('change',e=>{bgProps.blend=e.target.value;applyBg();});
$id('bgDraggable').addEventListener('change',e=>{
  bgDragEnable=e.target.checked; applyBg();
  const p=document.querySelector('.tool-btn[data-tool="pan"]');
  if(p){p.disabled=bgDragEnable;p.style.opacity=bgDragEnable?'0.4':'';if(bgDragEnable&&tool==='pan')setTool('draw');}
});
$id('bgToggle').addEventListener('click',()=>{bgVisible=!bgVisible;$id('bgToggle').textContent=bgVisible?'Ø¥Ø®ÙØ§Ø¡':'Ø¥Ø¸Ù‡Ø§Ø±';applyBg();});
$id('bgReset').addEventListener('click',()=>{bgProps.w=0;applyBg();syncBgControls();});
$id('bgRemove').addEventListener('click',()=>{bgImg=null;bgL.innerHTML='';bgL.style.cssText='';$id('bgControls').style.display='none';$id('bgFileInput').value='';});

// Re-position bgLayer when vp scrolls (since bgLayer is vp-relative)
vp.addEventListener('scroll',()=>{if(bgImg)applyBg();});

/* â•â•â•â•â•â•â•â•â•â• RULERS â•â•â•â•â•â•â•â•â•â• */
function initRulers(){
  let rHDrag=false,rHStart={};
  rulerH.addEventListener('pointerdown',e=>{rHDrag=true;rHStart={my:e.clientY,top0:rulerH.offsetTop};rulerH.setPointerCapture(e.pointerId);e.stopPropagation();});
  rulerH.addEventListener('pointermove',e=>{if(!rHDrag)return;e.stopPropagation();const t=rHStart.top0+(e.clientY-rHStart.my);rulerH.style.top=t+'px';const gcR=gc.getBoundingClientRect();const row=Math.round(((t+vp.scrollTop-gcR.top)/zoom-20)/(cellSz+gapSz));rulerH.dataset.row='Y:'+Math.max(0,Math.min(rows-1,row));});
  rulerH.addEventListener('pointerup',e=>{rHDrag=false;try{rulerH.releasePointerCapture(e.pointerId);}catch(er){}});
  let rVDrag=false,rVStart={};
  rulerV.addEventListener('pointerdown',e=>{rVDrag=true;rVStart={mx:e.clientX,left0:rulerV.offsetLeft};rulerV.setPointerCapture(e.pointerId);e.stopPropagation();});
  rulerV.addEventListener('pointermove',e=>{if(!rVDrag)return;e.stopPropagation();const l=rVStart.left0+(e.clientX-rVStart.mx);rulerV.style.left=l+'px';const gcR=gc.getBoundingClientRect();const col=Math.round(((l+vp.scrollLeft-gcR.left)/zoom-20)/(cellSz+gapSz));rulerV.dataset.col='X:'+Math.max(0,Math.min(cols-1,col));});
  rulerV.addEventListener('pointerup',e=>{rVDrag=false;try{rulerV.releasePointerCapture(e.pointerId);}catch(er){}});
}
$id('showRulers').addEventListener('change',e=>{showRulers=e.target.checked;rulerH.style.display=showRulers?'block':'none';rulerV.style.display=showRulers?'block':'none';});

/* â•â•â•â•â•â•â•â•â•â• COLORS & TOOLS â•â•â•â•â•â•â•â•â•â• */
// (color listeners handled by SHARED SWATCH SYSTEM above)
$id('bgColor').addEventListener('input',e=>{document.documentElement.style.setProperty('--cell-bg',e.target.value);});
$id('canvasBgColor').addEventListener('input',e=>{$id('canvasArea').style.background=e.target.value;vp.style.background=e.target.value;});
$id('canvasDark').addEventListener('click',()=>{$id('canvasBgColor').value='#0A0C10';$id('canvasBgColor').dispatchEvent(new Event('input'));});
$id('canvasLight').addEventListener('click',()=>{$id('canvasBgColor').value='#F0EDE8';$id('canvasBgColor').dispatchEvent(new Event('input'));});
/* â•â•â•â•â•â•â•â•â•â• SHARED SWATCH SYSTEM â•â•â•â•â•â•â•â•â•â• */
const SWATCH_KEY = 'kufi_swatches';
const DEFAULT_SWATCHES = ['#7C3AED','#A855F7','#EF4444','#22C55E','#3B82F6','#EC4899','#14B8A6','#F5A623','#FFFFFF','#111827'];

function loadSwatchList(){
  try{ return JSON.parse(localStorage.getItem(SWATCH_KEY)) || DEFAULT_SWATCHES; }
  catch(e){ return DEFAULT_SWATCHES; }
}
function saveSwatchList(arr){ localStorage.setItem(SWATCH_KEY, JSON.stringify(arr)); }

function setDrawColorFull(color){
  drawColor = color;
  $id('fillColor').value = color;
  $id('quickColor').value = color;
  $id('colorPreview').style.background = color;
  syncSwatches();
}

function syncSwatches(){
  document.querySelectorAll('.swatch, .float-swatch').forEach(s=>{
    s.classList.toggle('selected', s.dataset.color===drawColor);
  });
}

function buildSwatches(){
  const list = loadSwatchList();

  // â”€â”€ Panel swatches (tab-tools) â”€â”€
  const container = $id('swatchesContainer');
  if(container){
    container.innerHTML='';
    list.forEach(color=>{
      const s=document.createElement('div');
      s.className='swatch'; s.style.background=color; s.dataset.color=color;
      if(color===drawColor) s.classList.add('selected');
      s.addEventListener('click',()=>setDrawColorFull(color));
      // Long press to remove
      let holdTimer=null;
      s.addEventListener('pointerdown',()=>{ holdTimer=setTimeout(()=>{ if(confirm(`Ø­Ø°Ù Ø§Ù„Ù„ÙˆÙ† ${color} Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ`)){ removeSwatchColor(color); }},700); });
      s.addEventListener('pointerup',()=>clearTimeout(holdTimer));
      s.addEventListener('pointerleave',()=>clearTimeout(holdTimer));
      container.appendChild(s);
    });
  }

  // â”€â”€ Floating toolbar swatches â”€â”€
  const floatEl = $id('floatSwatches');
  if(floatEl){
    floatEl.innerHTML='';
    list.forEach(color=>{
      const s=document.createElement('div');
      s.className='float-swatch'; s.style.background=color; s.dataset.color=color;
      if(color===drawColor) s.classList.add('selected');
      s.title=color;
      s.addEventListener('click',()=>setDrawColorFull(color));
      floatEl.appendChild(s);
    });
  }
}

function addSwatchColor(color){
  const list = loadSwatchList();
  if(!list.includes(color)){ list.push(color); saveSwatchList(list); }
  buildSwatches();
  setDrawColorFull(color);
}
function removeSwatchColor(color){
  let list = loadSwatchList().filter(c=>c!==color);
  if(list.length===0) list=[...DEFAULT_SWATCHES];
  saveSwatchList(list);
  buildSwatches();
}

/* â”€â”€ Color dropdown toggle â”€â”€ */
const colorDropBtn = document.getElementById('colorDropBtn');
const colorDropdown = document.getElementById('colorDropdown');
colorDropBtn.addEventListener('click', e=>{
  e.stopPropagation();
  colorDropdown.classList.toggle('open');
});
document.addEventListener('click', ()=> colorDropdown.classList.remove('open'));
colorDropdown.addEventListener('click', e=> e.stopPropagation());

// Add swatch button (in tools panel)
$id('btnAddSwatch').addEventListener('click',()=>$id('newSwatchColor').click());
$id('newSwatchColor').addEventListener('input',e=>addSwatchColor(e.target.value));

// fillColor + quickColor sync
$id('fillColor').addEventListener('input',e=>setDrawColorFull(e.target.value));
$id('quickColor').addEventListener('input',e=>setDrawColorFull(e.target.value));

function setTool(t){
  tool=t;
  document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.toggle('active',b.dataset.tool===t));
  vp.classList.toggle('pan-mode',t==='pan');
  $id('statusTool').textContent={draw:'Ø±Ø³Ù…',erase:'Ù…Ù…Ø­Ø§Ø©',fill:'Ù…Ù„Ø¡',pan:'ØªØ­Ø±ÙŠÙƒ'}[t]||t;
}
document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.addEventListener('click',()=>setTool(b.dataset.tool)));

/* â•â•â•â•â•â•â•â•â•â• GRID CONTROLS â•â•â•â•â•â•â•â•â•â• */
$id('cellSizeR').addEventListener('input',e=>{
  cellSz=+e.target.value; $id('cellSizeVal').textContent=cellSz;
  document.documentElement.style.setProperty('--cell-size',cellSz+'px');
  gc.style.gridTemplateColumns=`repeat(${cols},${cellSz}px)`;
  document.querySelectorAll('.cell').forEach(c=>{c.style.width=c.style.height=cellSz+'px';});
  drawAxisLines(); renderGapElements(); refreshAllRadius(); applyBg();
});
$id('gapSizeR').addEventListener('input',e=>{
  gapSz=+e.target.value; $id('gapSizeVal').textContent=gapSz;
  gc.style.gap=`${gapSz}px`;
  document.documentElement.style.setProperty('--gap',gapSz+'px');
  drawAxisLines(); renderGapElements(); refreshAllRadius();
});
$id('cellRadR').addEventListener('input',e=>{
  cellRad=+e.target.value; $id('cellRadVal').textContent=cellRad;
  refreshAllRadius(); renderGapElements();
});
$id('showAxis').addEventListener('change',e=>{showAxis=e.target.checked;drawAxisLines();});
$id('axisColor').addEventListener('input',e=>{axisColor=e.target.value;drawAxisLines();});
$id('axisEveryR').addEventListener('input',e=>{axisEvery=+e.target.value;$id('axisEveryVal').textContent=axisEvery;drawAxisLines();});

$id('applyGridSize').addEventListener('click',()=>{
  const c=Math.max(5,Math.min(120,+$id('gridCols').value));
  const r=Math.max(5,Math.min(120,+$id('gridRows').value));
  if(grid.flat().some(v=>v)){showConfirm('ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ø³ÙŠÙ…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ',()=>initGrid(c,r));}
  else initGrid(c,r);
});
document.querySelectorAll('[data-preset]').forEach(b=>{
  b.addEventListener('click',()=>{
    const[c,r]=b.dataset.preset.split(',').map(Number);
    $id('gridCols').value=c;$id('gridRows').value=r;$id('applyGridSize').click();
  });
});

/* â•â•â•â•â•â•â•â•â•â• ZOOM â•â•â•â•â•â•â•â•â•â• */
function setZoom(z){
  zoom=Math.max(0.25,Math.min(5,z));
  gc.style.transform=`scale(${zoom})`;
  gc.style.transformOrigin='top left';
  const txt=Math.round(zoom*100)+'%';
  const zl=$id('zoomLevel2'); if(zl) zl.textContent=txt;
  if(bgImg) applyBg();
}
// Wire topbar zoom buttons (they live in topbarRow2)
$id('zoomIn2').addEventListener('click',()=>setZoom(zoom+0.1));
$id('zoomOut2').addEventListener('click',()=>setZoom(zoom-0.1));
$id('zoomFit2').addEventListener('click',()=>{setZoom(1);vp.scrollTo({top:0,left:0,behavior:'smooth'});});
vp.addEventListener('wheel',e=>{
  if(e.ctrlKey||e.metaKey){e.preventDefault();setZoom(zoom+(e.deltaY<0?0.1:-0.1));}
},{passive:false});

/* â•â•â•â•â•â•â•â•â•â• LETTER BLOCKS â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LETTER LIBRARY â€” IndexedDB + Editor
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â•â•â•â•â•â•â•â•â•â• LETTER LIBRARY â€” External JSON + IndexedDB â•â•â•â•â•â•â•â•â•â•
   Flow:
   1. openDB()  â€” open IndexedDB 'KufiLetters' v2
   2. First run: fetch letters.json â†’ seed DB (store._default + user overrides)
   3. loadMergedLetters() â€” merge defaults + user overrides â†’ CUSTOM_LETTERS
   4. User edits â†’ saved to DB as user overrides (ch key)
   5. "Reset to default" â†’ delete all user overrides, reload defaults
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let lettersDB = null;
let CUSTOM_LETTERS = {};
let DEFAULT_LETTERS = {}; // loaded from letters.json, immutable at runtime

/* â”€â”€ IndexedDB â”€â”€ */
function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open('KufiLetters', 2);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      // letters store: user overrides keyed by ch
      if(!db.objectStoreNames.contains('letters'))
        db.createObjectStore('letters', {keyPath:'ch'});
      // meta store: flags like _defaultVersion
      if(!db.objectStoreNames.contains('meta'))
        db.createObjectStore('meta', {keyPath:'k'});
    };
    req.onsuccess = e => { lettersDB = e.target.result; res(lettersDB); };
    req.onerror   = () => rej(req.error);
  });
}

function dbGetAll(store='letters'){
  return new Promise(res=>{
    const tx = lettersDB.transaction(store,'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => res(req.result||[]);
    req.onerror   = () => res([]);
  });
}
function dbGet(key, store='meta'){
  return new Promise(res=>{
    const tx = lettersDB.transaction(store,'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => res(req.result||null);
    req.onerror   = () => res(null);
  });
}
function dbPut(obj, store='letters'){
  return new Promise(res=>{
    const tx = lettersDB.transaction(store,'readwrite');
    tx.objectStore(store).put(obj);
    tx.oncomplete = () => res();
    tx.onerror    = () => res();
  });
}
function dbDelete(ch, store='letters'){
  return new Promise(res=>{
    const tx = lettersDB.transaction(store,'readwrite');
    tx.objectStore(store).delete(ch);
    tx.oncomplete = () => res();
  });
}
function dbClearStore(store='letters'){
  return new Promise(res=>{
    const tx = lettersDB.transaction(store,'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => res();
  });
}

/* â”€â”€ Fetch default letters.json â”€â”€ */
async function fetchDefaultLetters(){
  try{
    // Build URL relative to the HTML file location (works on GitHub Pages /repo/ paths)
    const base = document.currentScript?.src
      ? new URL('.', document.currentScript.src).href
      : new URL('.', location.href).href;
    const url = new URL('letters.json', base).href;
    const r = await fetch(url);
    if(!r.ok) throw new Error('not found');
    const json = await r.json();
    return json.letters || {};
  }catch(e){
    console.warn('letters.json not found, library will be empty');
    return {};
  }
}

/* â”€â”€ Seed DB on first run (or when default version changes) â”€â”€ */
async function seedDefaultsIfNeeded(){
  const defaults = await fetchDefaultLetters();
  DEFAULT_LETTERS = defaults;
  const meta = await dbGet('_defaultVersion');
  const currentVer = 1; // bump this when you update letters.json
  if(!meta || meta.v !== currentVer){
    // First time or version changed â€” nothing to clear
    // (user overrides stay, we just update our in-memory defaults)
    await dbPut({k:'_defaultVersion', v: currentVer}, 'meta');
  }
}

/* â”€â”€ Build CUSTOM_LETTERS: defaults merged with user overrides â”€â”€ */
async function loadMergedLetters(){
  await seedDefaultsIfNeeded();
  const userOverrides = await dbGetAll('letters');
  CUSTOM_LETTERS = {};

  // 1. Load defaults
  Object.entries(DEFAULT_LETTERS).forEach(([ch, v])=>{
    const rows = v.m.length, cols = v.m[0]?.length||1;
    CUSTOM_LETTERS[ch] = {
      name: v.name,
      m:    v.m,
      gH:   v.gH || Array.from({length:rows-1}, ()=>Array(cols).fill(0)),
      gV:   v.gV || Array.from({length:rows},   ()=>Array(cols-1).fill(0)),
      gD:   v.gD || Array.from({length:rows-1}, ()=>Array(cols-1).fill(0)),
      _builtin: true
    };
  });

  // 2. Overlay user overrides (user edits win)
  userOverrides.forEach(obj=>{
    const rows = obj.m.length, cols = obj.m[0]?.length||1;
    CUSTOM_LETTERS[obj.ch] = {
      name: obj.name, m: obj.m,
      gH:   obj.gH || Array.from({length:rows-1}, ()=>Array(cols).fill(0)),
      gV:   obj.gV || Array.from({length:rows},   ()=>Array(cols-1).fill(0)),
      gD:   obj.gD || Array.from({length:rows-1}, ()=>Array(cols-1).fill(0)),
      _builtin: false
    };
  });
}

async function saveLetterToDB(ch, name, m){
  await dbPut({ch, name, m, gH:[], gV:[], gD:[]});
  CUSTOM_LETTERS[ch] = {name, m, gH:[], gV:[], gD:[], _builtin:false};
}

async function deleteLetterFromDB(ch){
  await dbDelete(ch);
  // Restore from defaults if it exists there
  if(DEFAULT_LETTERS[ch]){
    const v = DEFAULT_LETTERS[ch];
    const rows = v.m.length, cols = v.m[0].length;
    CUSTOM_LETTERS[ch] = {
      name: v.name, m: v.m,
      gH: v.gH || Array.from({length:rows-1}, ()=>Array(cols).fill(0)),
      gV: v.gV || Array.from({length:rows},   ()=>Array(cols-1).fill(0)),
      gD: v.gD || Array.from({length:rows-1}, ()=>Array(cols-1).fill(0)),
      _builtin: true
    };
  } else {
    delete CUSTOM_LETTERS[ch];
  }
}

/* â”€â”€ Reset ALL user overrides â†’ back to letters.json â”€â”€ */
async function resetToDefaults(){
  await dbClearStore('letters');
  await loadMergedLetters();
  buildLetters($id('libSearch').value);
}

/* â”€â”€ Build Library UI â”€â”€ */
function buildLetters(filter=''){
  const lib=$id('letterLibrary'); lib.innerHTML='';
  const fl=filter.trim().toLowerCase();
  Object.entries(CUSTOM_LETTERS)
    .filter(([ch,{name}])=>!fl||ch.includes(fl)||name.toLowerCase().includes(fl))
    .forEach(([ch,{name,m,gH,gV,_builtin}])=>{
    const card=document.createElement('div'); card.className='letter-card';
    // mini preview via canvas (correct, no mirror issue)
    const rows=m.length, cols=m[0]?.length||1;
    const dotSz=3, gapDotSz=1, T=dotSz+gapDotSz;
    const cw=cols*T-gapDotSz, ch2=rows*T-gapDotSz;
    const cv=document.createElement('canvas'); cv.width=cw; cv.height=ch2;
    cv.style.cssText=`display:block;image-rendering:pixelated;`;
    const ctx=cv.getContext('2d');
    ctx.clearRect(0,0,cw,ch2);
    // cells
    m.forEach((row,y)=>row.forEach((v,x)=>{
      if(!v) return;
      ctx.fillStyle='#F5A623';
      ctx.fillRect(x*T,y*T,dotSz,dotSz);
    }));
    // gapH
    if(gH) gH.forEach((row,y)=>row.forEach((v,x)=>{
      if(!v) return;
      ctx.fillStyle='#F5A623';
      ctx.fillRect(x*T,(y+1)*T-gapDotSz,dotSz,gapDotSz);
    }));
    // gapV
    if(gV) gV.forEach((row,y)=>row.forEach((v,x)=>{
      if(!v) return;
      ctx.fillStyle='#F5A623';
      ctx.fillRect((x+1)*T-gapDotSz,y*T,gapDotSz,dotSz);
    }));
    const nm=document.createElement('div'); nm.className='lc-name'; nm.textContent=name+(_builtin?'':' âœ');
    const chLbl=document.createElement('div'); chLbl.className='lc-char'; chLbl.textContent=ch;
    // action buttons overlay
    const acts=document.createElement('div'); acts.className='lc-actions';
    const editBtn=document.createElement('button'); editBtn.className='lc-act-btn'; editBtn.title='ØªØ¹Ø¯ÙŠÙ„';
    editBtn.innerHTML='âœ';
    editBtn.addEventListener('click',e=>{e.stopPropagation();openEditor(ch);});
    acts.appendChild(editBtn);
    card.appendChild(acts);
    card.appendChild(cv);card.appendChild(chLbl);card.appendChild(nm);
    card.addEventListener('click',()=>addLetter(ch));
    lib.appendChild(card);
  });
  if(lib.children.length===0){
    lib.innerHTML=`<div style="color:var(--muted);font-size:11px;text-align:center;padding:12px;grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
  }
}

$id('libSearch').addEventListener('input',e=>buildLetters(e.target.value));

/* â”€â”€ Letter Editor â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LETTER EDITOR â€” Real grid with cells + gapH + gapV + gapD
   Mirrors the main canvas so letters look identical when placed
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let leMatrix=[];            // cells [rows][cols]
let leGapH=[];              // horizontal gaps [rows-1][cols]
let leGapV=[];              // vertical gaps   [rows][cols-1]
let leGapD=[];              // corner dots     [rows-1][cols-1]
let leEditCh=null;
let leDrawing=false, leDrawVal=1, leDrawType=null;
let leTool='draw'; // 'draw' | 'erase'

// Editor display constants â€” calculated from available space
const LE_PAD=8;

function leCalcSizes(rows,cols){
  const maxW=Math.min(window.innerWidth*0.88, 400) - LE_PAD*2 - 20;
  const maxH=Math.min(window.innerHeight*0.5, 300) - LE_PAD*2;
  // cellSz and gapSz proportional to main canvas ratio (gap = 0.33 * cell)
  const totalCols = cols + (cols-1)*0.38;
  const totalRows = rows + (rows-1)*0.38;
  const szFromW = maxW / totalCols;
  const szFromH = maxH / totalRows;
  const cSz = Math.max(8, Math.min(28, Math.floor(Math.min(szFromW,szFromH))));
  const gSz = Math.max(3, Math.round(cSz * 0.38));
  return {cSz, gSz};
}

function leInitArrays(rows,cols,keepExisting=false){
  const oldM=leMatrix, oldH=leGapH, oldV=leGapV, oldD=leGapD;
  leMatrix = Array.from({length:rows},(_,y)=>Array.from({length:cols},(_,x)=>keepExisting?(oldM[y]?.[x]||0):0));
  leGapH   = Array.from({length:rows-1},(_,y)=>Array.from({length:cols},(_,x)=>keepExisting?(oldH[y]?.[x]||0):0));
  leGapV   = Array.from({length:rows},(_,y)=>Array.from({length:cols-1},(_,x)=>keepExisting?(oldV[y]?.[x]||0):0));
  leGapD   = Array.from({length:rows-1},(_,y)=>Array.from({length:cols-1},(_,x)=>keepExisting?(oldD[y]?.[x]||0):0));
}

function openEditor(ch=null){
  leEditCh=ch;
  const existing = ch ? CUSTOM_LETTERS[ch] : null;
  $id('leModalTitle').textContent = ch ? `ØªØ¹Ø¯ÙŠÙ„: ${ch}` : 'Ø­Ø±Ù Ø¬Ø¯ÙŠØ¯';
  $id('leChar').value = ch||'';
  $id('leName').value = existing?.name||'';
  $id('leDeleteBtn').style.display = ch ? 'block':'none';
  const rows = existing ? existing.m.length : 5;
  const cols = existing ? existing.m[0].length : 5;
  $id('leGridH').value=rows; $id('leGridW').value=cols;
  // Load existing data
  leMatrix = existing ? existing.m.map(r=>[...r]) : Array.from({length:rows},()=>Array(cols).fill(0));
  leGapH   = existing?.gH ? existing.gH.map(r=>[...r]) : Array.from({length:rows-1},()=>Array(cols).fill(0));
  leGapV   = existing?.gV ? existing.gV.map(r=>[...r]) : Array.from({length:rows},()=>Array(cols-1).fill(0));
  leGapD   = existing?.gD ? existing.gD.map(r=>[...r]) : Array.from({length:rows-1},()=>Array(cols-1).fill(0));
  leTool='draw'; leSetTool('draw');
  renderLeEditor();
  $id('letterEditorModal').classList.add('open');
}

function leSetTool(t){
  leTool=t;
  document.querySelectorAll('.le-tool-btn').forEach(b=>b.classList.toggle('active',b.dataset.letool===t));
}
document.querySelectorAll('.le-tool-btn').forEach(b=>b.addEventListener('click',()=>leSetTool(b.dataset.letool)));

/* â”€â”€ Render the editor grid (absolute-positioned like main canvas) â”€â”€ */
function renderLeEditor(){
  const rows=leMatrix.length, cols=leMatrix[0]?.length||1;
  const {cSz, gSz} = leCalcSizes(rows,cols);
  const total = cSz + gSz;
  const W = LE_PAD*2 + cols*cSz + (cols-1)*gSz;
  const H = LE_PAD*2 + rows*cSz + (rows-1)*gSz;
  const eg=$id('leEditorGrid');
  eg.innerHTML='';
  eg.style.width=W+'px'; eg.style.height=H+'px';

  // Cells
  for(let y=0;y<rows;y++) for(let x=0;x<cols;x++){
    const el=document.createElement('div');
    el.className='le-gcell'+(leMatrix[y][x]?' on':'');
    el.dataset.t='c'; el.dataset.x=x; el.dataset.y=y;
    const R=leMatrix[y][x]?leCellRad(x,y,cSz):`${Math.min(cSz/4,4)}px`;
    el.style.cssText=`left:${LE_PAD+x*total}px;top:${LE_PAD+y*total}px;width:${cSz}px;height:${cSz}px;border-radius:${R};`;
    eg.appendChild(el);
  }
  // gapH (horizontal â€” between rows)
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols;gx++){
    const v=leGapH[gy][gx];
    const el=document.createElement('div');
    el.className='le-gH'+(v?' on':'');
    el.dataset.t='h'; el.dataset.x=gx; el.dataset.y=gy;
    el.style.cssText=`left:${LE_PAD+gx*total}px;top:${LE_PAD+(gy+1)*total-gSz}px;width:${cSz}px;height:${gSz}px;border-radius:${v?leGHRad(gx,gy,cSz):'0'};`;
    eg.appendChild(el);
  }
  // gapV (vertical â€” between cols)
  for(let gy=0;gy<rows;gy++) for(let gx=0;gx<cols-1;gx++){
    const v=leGapV[gy][gx];
    const el=document.createElement('div');
    el.className='le-gV'+(v?' on':'');
    el.dataset.t='v'; el.dataset.x=gx; el.dataset.y=gy;
    el.style.cssText=`left:${LE_PAD+(gx+1)*total-gSz}px;top:${LE_PAD+gy*total}px;width:${gSz}px;height:${cSz}px;border-radius:${v?leGVRad(gx,gy,cSz):'0'};`;
    eg.appendChild(el);
  }
  // gapD (corner dots)
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols-1;gx++){
    const v=leGapD[gy][gx];
    const el=document.createElement('div');
    el.className='le-gD'+(v?' on':'');
    el.dataset.t='d'; el.dataset.x=gx; el.dataset.y=gy;
    const dr=v?Math.min(Math.floor(gSz/2),3):0;
    el.style.cssText=`left:${LE_PAD+(gx+1)*total-gSz}px;top:${LE_PAD+(gy+1)*total-gSz}px;width:${gSz}px;height:${gSz}px;border-radius:${dr}px;`;
    eg.appendChild(el);
  }

  // Pointer events
  let drawing=false, dVal=1, dType=null;
  eg.onpointerdown=e=>{
    const el=e.target; if(!el.dataset.t) return;
    e.preventDefault(); drawing=true;
    eg.setPointerCapture(e.pointerId);
    const t=el.dataset.t, x=+el.dataset.x, y=+el.dataset.y;
    dType=t;
    const cur=leGetVal(t,x,y);
    dVal = leTool==='erase' ? 0 : (cur?0:1); // toggle on first click
    leSetVal(t,x,y,dVal);
    leRefreshEl(el,t,x,y,cSz,gSz);
    leRefreshNeighbours(t,x,y,cSz,gSz);
  };
  eg.onpointermove=e=>{
    if(!drawing) return;
    const raw=document.elementFromPoint(e.clientX,e.clientY);
    const el=raw?.closest?.('[data-t]')||raw;
    if(!el?.dataset?.t) return;
    const t=el.dataset.t, x=+el.dataset.x, y=+el.dataset.y;
    if(t!==dType) return; // only paint same type during drag
    if(leGetVal(t,x,y)===dVal) return;
    leSetVal(t,x,y,dVal);
    leRefreshEl(el,t,x,y,cSz,gSz);
    leRefreshNeighbours(t,x,y,cSz,gSz);
  };
  eg.onpointerup=()=>{drawing=false;};
  eg.onpointercancel=()=>{drawing=false;};
}

function leGetVal(t,x,y){
  if(t==='c') return leMatrix[y]?.[x]||0;
  if(t==='h') return leGapH[y]?.[x]||0;
  if(t==='v') return leGapV[y]?.[x]||0;
  if(t==='d') return leGapD[y]?.[x]||0;
  return 0;
}
function leSetVal(t,x,y,v){
  if(t==='c'&&leMatrix[y]) leMatrix[y][x]=v;
  else if(t==='h'&&leGapH[y]) leGapH[y][x]=v;
  else if(t==='v'&&leGapV[y]) leGapV[y][x]=v;
  else if(t==='d'&&leGapD[y]) leGapD[y][x]=v;
}

/* â”€â”€ Smart radius functions for the editor (mirrors main canvas) â”€â”€ */
function leFC(x,y){const r=leMatrix.length,c=leMatrix[0]?.length||0;return x>=0&&x<c&&y>=0&&y<r&&leMatrix[y][x]===1;}
function leGH(x,y){const r=leGapH.length,c=leGapH[0]?.length||0;return y>=0&&y<r&&x>=0&&x<c&&leGapH[y][x]===1;}
function leGV(x,y){const r=leGapV.length,c=leGapV[0]?.length||0;return y>=0&&y<r&&x>=0&&x<c&&leGapV[y][x]===1;}
function leGD(x,y){const r=leGapD.length,c=leGapD[0]?.length||0;return y>=0&&y<r&&x>=0&&x<c&&leGapD[y][x]===1;}
function leRc(blocked,cSz){return(blocked)?0:Math.min(cSz/4,4);}

function leCellRad(x,y,cSz){
  const tl=leRc(leGV(x-1,y)||leGH(x,y-1)||leGD(x-1,y-1),cSz);
  const tr=leRc(leGV(x,  y)||leGH(x,y-1)||leGD(x,  y-1),cSz);
  const bl=leRc(leGV(x-1,y)||leGH(x,y  )||leGD(x-1,y  ),cSz);
  const br=leRc(leGV(x,  y)||leGH(x,y  )||leGD(x,  y  ),cSz);
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}
function leGHRad(gx,gy,cSz){
  const tl=leRc(leFC(gx,gy)  ||leGV(gx-1,gy)  ||leGD(gx-1,gy),cSz);
  const tr=leRc(leFC(gx,gy)  ||leGV(gx,  gy)  ||leGD(gx,  gy),cSz);
  const bl=leRc(leFC(gx,gy+1)||leGV(gx-1,gy+1)||leGD(gx-1,gy),cSz);
  const br=leRc(leFC(gx,gy+1)||leGV(gx,  gy+1)||leGD(gx,  gy),cSz);
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}
function leGVRad(gx,gy,cSz){
  const tl=leRc(leFC(gx,  gy)||leGH(gx,  gy-1)||leGD(gx,gy-1),cSz);
  const tr=leRc(leFC(gx+1,gy)||leGH(gx+1,gy-1)||leGD(gx,gy-1),cSz);
  const bl=leRc(leFC(gx,  gy)||leGH(gx,  gy)  ||leGD(gx,gy),cSz);
  const br=leRc(leFC(gx+1,gy)||leGH(gx+1,gy)  ||leGD(gx,gy),cSz);
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

function leGDRad(gx,gy,cSz){
  const maxR=Math.min(Math.floor(cSz*0.38/2),3);
  const r2=(b)=>b?0:maxR;
  const tl=r2(leFC(gx,  gy)  ||leGH(gx,  gy)||leGV(gx,gy));
  const tr=r2(leFC(gx+1,gy)  ||leGH(gx+1,gy)||leGV(gx,gy));
  const bl=r2(leFC(gx,  gy+1)||leGH(gx,  gy)||leGV(gx,gy+1));
  const br=r2(leFC(gx+1,gy+1)||leGH(gx+1,gy)||leGV(gx,gy+1));
  return `${tl}px ${tr}px ${br}px ${bl}px`;
}

function leRefreshEl(el,t,x,y,cSz,gSz){
  const v=leGetVal(t,x,y);
  el.classList.toggle('on',!!v);
  if(t==='c') el.style.borderRadius=v?leCellRad(x,y,cSz):`${Math.min(cSz/4,4)}px`;
  else if(t==='h') el.style.borderRadius=v?leGHRad(x,y,cSz):'0';
  else if(t==='v') el.style.borderRadius=v?leGVRad(x,y,cSz):'0';
  else if(t==='d') el.style.borderRadius=v?leGDRad(x,y,cSz):'0';
}

function leGetElAt(t,x,y){
  return $id('leEditorGrid').querySelector(`[data-t="${t}"][data-x="${x}"][data-y="${y}"]`);
}
function leRefreshNeighbours(t,x,y,cSz,gSz){
  const rows=leMatrix.length, cols=leMatrix[0]?.length||1;
  // Refresh all cells nearby
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx, ny=y+dy;
    if(nx<0||nx>=cols||ny<0||ny>=rows) continue;
    const el=leGetElAt('c',nx,ny); if(!el) continue;
    leRefreshEl(el,'c',nx,ny,cSz,gSz);
  }
  // Refresh nearby gaps
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    ['h','v','d'].forEach(gt=>{
      const nx=x+dx, ny=y+dy;
      const el=leGetElAt(gt,nx,ny); if(!el) return;
      leRefreshEl(el,gt,nx,ny,cSz,gSz);
    });
  }
}

$id('leResizeBtn').addEventListener('click',()=>{
  const nw=Math.max(1,Math.min(20,+$id('leGridW').value));
  const nh=Math.max(1,Math.min(20,+$id('leGridH').value));
  leInitArrays(nh,nw,true);
  renderLeEditor();
});
$id('leClearBtn').addEventListener('click',()=>{
  const rows=leMatrix.length, cols=leMatrix[0]?.length||1;
  leInitArrays(rows,cols,false);
  renderLeEditor();
});
$id('leClose').addEventListener('click',()=>$id('letterEditorModal').classList.remove('open'));
$id('leCancelBtn').addEventListener('click',()=>$id('letterEditorModal').classList.remove('open'));

$id('leSaveBtn').addEventListener('click',async()=>{
  const ch=$id('leChar').value.trim();
  const name=$id('leName').value.trim()||ch;
  if(!ch){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ø±Ù Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²');return;}
  if(!leMatrix.flat().some(v=>v)&&!leGapH.flat().some(v=>v)&&!leGapV.flat().some(v=>v)){
    alert('Ø§Ø±Ø³Ù… Ø´ÙƒÙ„ Ø§Ù„Ø­Ø±Ù ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©');return;
  }
  // Save with gaps
  const obj={ch,name,
    m:leMatrix.map(r=>[...r]),
    gH:leGapH.map(r=>[...r]),
    gV:leGapV.map(r=>[...r]),
    gD:leGapD.map(r=>[...r])
  };
  await dbPut(obj);
  CUSTOM_LETTERS[ch]={name,m:obj.m,gH:obj.gH,gV:obj.gV,gD:obj.gD,_builtin:false};
  buildLetters($id('libSearch').value);
  $id('letterEditorModal').classList.remove('open');
});

$id('leDeleteBtn').addEventListener('click',async()=>{
  if(!leEditCh) return;
  const isBuiltin=CUSTOM_LETTERS[leEditCh]?._builtin;
  const msg=isBuiltin
    ? `Ù‡Ø°Ø§ Ø­Ø±Ù Ù…Ø¯Ù…Ø¬. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŸ`
    : `Ø­Ø°Ù Ø§Ù„Ø­Ø±Ù "${leEditCh}"ØŸ`;
  if(!confirm(msg)) return;
  await deleteLetterFromDB(leEditCh);
  buildLetters($id('libSearch').value);
  $id('letterEditorModal').classList.remove('open');
});

/* â”€â”€ Export / Import â”€â”€ */
$id('btnAddLetter').addEventListener('click',()=>openEditor(null));

// Reset to defaults
$id('btnResetLib').addEventListener('click',async()=>{
  if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙˆÙ Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±ÙˆÙ.')) return;
  await resetToDefaults();
  alert('âœ“ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
});

$id('btnExportLib').addEventListener('click',()=>{
  const all={};
  Object.entries(CUSTOM_LETTERS).forEach(([ch,{name,m,gH,gV,gD}])=>{
    all[ch]={name,m,gH:gH||[],gV:gV||[],gD:gD||[]};
  });
  const blob=new Blob([JSON.stringify({letters:all,_exported:Date.now()},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`kufi-letters-${Date.now()}.json`; a.click();
});

$id('btnImportLib').addEventListener('click',()=>$id('importLibFile').click());
$id('importLibFile').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text=await f.text();
    const json=JSON.parse(text);
    const src=json.letters||json;
    let count=0;
    for(const [ch,val] of Object.entries(src)){
      if(ch.startsWith('_')) continue;
      if(!val.name||!Array.isArray(val.m)) continue;
      const rows=val.m.length, cols=val.m[0]?.length||1;
      await dbPut({
        ch, name:val.name, m:val.m,
        gH: val.gH||Array.from({length:rows-1},()=>Array(cols).fill(0)),
        gV: val.gV||Array.from({length:rows},()=>Array(cols-1).fill(0)),
        gD: val.gD||Array.from({length:rows-1},()=>Array(cols-1).fill(0))
      });
      count++;
    }
    await loadMergedLetters();
    buildLetters();
    alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø­Ø±Ù Ø¨Ù†Ø¬Ø§Ø­`);
  }catch(err){alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: '+err.message);}
  e.target.value='';
});

/* â”€â”€ addLetter â€” copies cells + all gaps to main canvas â”€â”€ */
function addLetter(ch){
  const entry=CUSTOM_LETTERS[ch]; if(!entry) return;
  const {m, gH, gV, gD} = entry;
  const lRows=m.length, lCols=m[0]?.length||1;
  const sx=Math.max(0,+$id('placeX').value), sy=Math.max(0,+$id('placeY').value);
  saveState();

  // â”€â”€ Place cells â”€â”€
  const cells=[];
  m.forEach((row,dy)=>row.forEach((v,dx)=>{
    const x=sx+dx, y=sy+dy;
    if(v&&x<cols&&y<rows){
      grid[y][x]=1; cellColors[`${x},${y}`]=drawColor;
      const el=cellEl(x,y);
      if(el){el.classList.add('filled');el.style.background=drawColor;}
      cells.push({x,y});
    }
  }));

  // â”€â”€ gapOffsets: store relative (lx,ly) from block's top-left â”€â”€
  // so when block moves by (dx,dy), new absolute = (sx+dx+lx, sy+dy+ly)
  const gapOffsets=[];

  // â”€â”€ Place gapH â”€â”€
  if(gH) gH.forEach((row,dy)=>row.forEach((v,dx)=>{
    const ax=sx+dx, ay=sy+dy;
    if(v&&ax<cols&&ay<rows-1){
      gapH[ay][ax]=1; gapHColors[`${ax},${ay}`]=drawColor;
      gapOffsets.push({t:'h', lx:dx, ly:dy});
    }
  }));

  // â”€â”€ Place gapV â”€â”€
  if(gV) gV.forEach((row,dy)=>row.forEach((v,dx)=>{
    const ax=sx+dx, ay=sy+dy;
    if(v&&ax<cols-1&&ay<rows){
      gapV[ay][ax]=1; gapVColors[`${ax},${ay}`]=drawColor;
      gapOffsets.push({t:'v', lx:dx, ly:dy});
    }
  }));

  // â”€â”€ Place gapD â”€â”€
  if(gD) gD.forEach((row,dy)=>row.forEach((v,dx)=>{
    const ax=sx+dx, ay=sy+dy;
    if(v&&ax<cols-1&&ay<rows-1){
      gapD[ay][ax]=1; gapDColors[`${ax},${ay}`]=drawColor;
      gapOffsets.push({t:'d', lx:dx, ly:dy});
    }
  }));

  // â”€â”€ Refresh radius + render gaps â”€â”€
  cells.forEach(({x,y})=>{const el=cellEl(x,y);if(el)el.style.borderRadius=computeCellRadius(x,y);});
  cells.forEach(({x,y})=>refreshRadiusAround(x,y));
  renderGapElements();
  refreshAllRadius();

  const block={id:blockCounter++,ch,cells:[...cells],color:drawColor,gapOffsets,
    // Store the true origin (top-left of letter grid, not just filled cells)
    originX:sx, originY:sy
  };
  blocks.push(block); createBlockOverlay(block);
  if($id('autoAdvance').checked){const nx=sx+lCols+1;$id('placeX').value=nx<cols?nx:0;}
  updateStatus();
}

function createBlockOverlay(block){
  const pad=20, total=cellSz+gapSz;
  if(!block.cells.length) return;
  const div=document.createElement('div');
  div.className='block-overlay'; div.dataset.blockId=block.id;

  function reposition(){
    const xs=block.cells.map(c=>c.x), ys=block.cells.map(c=>c.y);
    const mnX=Math.min(...xs),mnY=Math.min(...ys),mxX=Math.max(...xs),mxY=Math.max(...ys);
    div.style.left=(pad+mnX*total)+'px'; div.style.top=(pad+mnY*total)+'px';
    div.style.width=((mxX-mnX+1)*total)+'px'; div.style.height=((mxY-mnY+1)*total)+'px';
  }
  reposition();

  const lbl=document.createElement('div'); lbl.className='block-overlay-label'; lbl.textContent=block.ch; div.appendChild(lbl);
  const hint=document.createElement('div'); hint.className='block-overlay-hint'; hint.textContent='Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ'; div.appendChild(hint);

  // â”€â”€ Merge button (tap/click to stamp permanently) â”€â”€
  const mergeBtn=document.createElement('button');
  mergeBtn.className='block-merge-btn';
  mergeBtn.title='Ø¯Ù…Ø¬ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©';
  mergeBtn.innerHTML='âœ“';
  mergeBtn.addEventListener('pointerdown',e=>{e.stopPropagation();});
  mergeBtn.addEventListener('click',e=>{
    e.stopPropagation();
    stampBlock();
    blocks=blocks.filter(b=>b.id!==block.id);
    div.remove(); updateStatus();
  });
  div.appendChild(mergeBtn);

  let dragStart=null;

  /* Remove all cells + gaps of this block from canvas */
  function eraseBlock(){
    block.cells.forEach(({x,y})=>{
      if(x<0||x>=cols||y<0||y>=rows) return;
      grid[y][x]=0; delete cellColors[`${x},${y}`];
      const el=cellEl(x,y);
      if(el){el.classList.remove('filled');el.style.background='';el.style.borderRadius=`${cellRad}px`;}
    });
    if(block.gapOffsets) block.gapOffsets.forEach(({t,lx,ly})=>{
      const ax=block.originX+lx, ay=block.originY+ly;
      if(t==='h'&&ay>=0&&ay<rows-1&&ax>=0&&ax<cols){gapH[ay][ax]=0;delete gapHColors[`${ax},${ay}`];}
      else if(t==='v'&&ay>=0&&ay<rows&&ax>=0&&ax<cols-1){gapV[ay][ax]=0;delete gapVColors[`${ax},${ay}`];}
      else if(t==='d'&&ay>=0&&ay<rows-1&&ax>=0&&ax<cols-1){gapD[ay][ax]=0;delete gapDColors[`${ax},${ay}`];}
    });
    block.cells.forEach(({x,y})=>{if(x>=0&&x<cols&&y>=0&&y<rows)refreshRadiusAround(x,y);});
  }

  /* Write all cells + gaps of this block to canvas */
  function stampBlock(){
    block.cells.forEach(({x,y})=>{
      if(x<0||x>=cols||y<0||y>=rows) return;
      grid[y][x]=1; cellColors[`${x},${y}`]=block.color;
      const el=cellEl(x,y);
      if(el){el.classList.add('filled');el.style.background=block.color;}
    });
    if(block.gapOffsets) block.gapOffsets.forEach(({t,lx,ly})=>{
      const ax=block.originX+lx, ay=block.originY+ly;
      if(t==='h'&&ax>=0&&ax<cols&&ay>=0&&ay<rows-1){gapH[ay][ax]=1;gapHColors[`${ax},${ay}`]=block.color;}
      else if(t==='v'&&ax>=0&&ax<cols-1&&ay>=0&&ay<rows){gapV[ay][ax]=1;gapVColors[`${ax},${ay}`]=block.color;}
      else if(t==='d'&&ax>=0&&ax<cols-1&&ay>=0&&ay<rows-1){gapD[ay][ax]=1;gapDColors[`${ax},${ay}`]=block.color;}
    });
    block.cells.forEach(({x,y})=>{if(x>=0&&x<cols&&y>=0&&y<rows){const el=cellEl(x,y);if(el)el.style.borderRadius=computeCellRadius(x,y);}});
    block.cells.forEach(({x,y})=>{if(x>=0&&x<cols&&y>=0&&y<rows)refreshRadiusAround(x,y);});
    renderGapElements(); refreshAllRadius();
  }

  div.addEventListener('pointerdown',e=>{
    e.stopPropagation(); e.preventDefault();
    div.setPointerCapture(e.pointerId);
    saveState();
    dragStart={
      mx:e.clientX, my:e.clientY,
      origCells:block.cells.map(c=>({...c})),
      origOriginX:block.originX,
      origOriginY:block.originY,
      lastDdx:0, lastDdy:0
    };
    eraseBlock();
    renderGapElements(); refreshAllRadius();
  });

  div.addEventListener('pointermove',e=>{
    if(!dragStart) return;
    e.stopPropagation();
    const T=cellSz+gapSz;
    const ddx=Math.round((e.clientX-dragStart.mx)/(T*zoom));
    const ddy=Math.round((e.clientY-dragStart.my)/(T*zoom));
    if(ddx===dragStart.lastDdx && ddy===dragStart.lastDdy) return;
    const nc=dragStart.origCells.map(c=>({x:c.x+ddx,y:c.y+ddy}));
    if(!nc.every(c=>c.x>=0&&c.x<cols&&c.y>=0&&c.y<rows)) return;
    dragStart.lastDdx=ddx; dragStart.lastDdy=ddy;
    // Erase ghost at old position
    eraseBlock();
    // Update block position
    block.cells=nc;
    block.originX=dragStart.origOriginX+ddx;
    block.originY=dragStart.origOriginY+ddy;
    // Stamp at new position
    stampBlock();
    reposition();
  });

  div.addEventListener('pointerup',e=>{
    if(!dragStart) return;
    try{div.releasePointerCapture(e.pointerId);}catch(_){}
    stampBlock();
    dragStart=null;
    updateStatus(); reposition();
  });

  div.addEventListener('pointercancel',e=>{
    if(!dragStart) return;
    eraseBlock();
    block.cells=dragStart.origCells;
    block.originX=dragStart.origOriginX;
    block.originY=dragStart.origOriginY;
    stampBlock();
    dragStart=null; reposition();
  });

  // dblclick as fallback for desktop
  div.addEventListener('dblclick',e=>{
    e.stopPropagation();
    stampBlock();
    blocks=blocks.filter(b=>b.id!==block.id);
    div.remove(); updateStatus();
  });

  gc.appendChild(div);
}

/* â•â•â•â•â•â•â•â•â•â• BOTTOM SHEET â•â•â•â•â•â•â•â•â•â• */
const bsOverlay=$id('sheetOverlay');
const bsSheet=$id('bottomSheet');
const bsContent=$id('bsContent');
let currentSheet=null;

function openSheet(tabName){
  if(currentSheet===tabName && bsSheet.classList.contains('open')){
    closeSheet(); return;
  }
  currentSheet=tabName;
  bsContent.innerHTML='';
  const pane=$id('tab-'+tabName);
  if(pane) bsContent.appendChild(pane);
  document.querySelectorAll('.bs-tab').forEach(t=>t.classList.toggle('active',t.dataset.sheet===tabName));
  document.querySelectorAll('[data-sheet]').forEach(b=>b.classList.toggle('sheet-active',b.dataset.sheet===tabName && b.tagName==='BUTTON'));
  // Force overlay visible (desktop had display:none)
  bsOverlay.style.display='flex';
  bsOverlay.classList.add('open');
  // Next frame so CSS transition fires
  requestAnimationFrame(()=>{ requestAnimationFrame(()=>bsSheet.classList.add('open')); });
  sessionStorage.setItem('lastSheet', tabName);
}

function closeSheet(){
  bsSheet.classList.remove('open');
  bsOverlay.classList.remove('open');
  document.querySelectorAll('[data-sheet]').forEach(b=>b.classList.remove('sheet-active'));
  const cleanup=()=>{
    if(currentSheet){
      const pane=$id('tab-'+currentSheet);
      if(pane) $id('tabPanesStore').appendChild(pane);
    }
    currentSheet=null;
    // On desktop: re-apply display:none via CSS :not(.open) rule
    bsOverlay.style.display='';
  };
  // Wait for animation then clean up
  setTimeout(cleanup, 350);
}
$id('bsClose').addEventListener('click',closeSheet);
// Click on overlay background (not the sheet itself) â†’ close
bsOverlay.addEventListener('click',e=>{
  if(e.target===bsOverlay) closeSheet();
});

// Bottom sheet tabs (switch tab within open sheet)
document.querySelectorAll('.bs-tab').forEach(t=>{
  t.addEventListener('click',()=>openSheet(t.dataset.sheet));
});
// Topbar sheet buttons
document.querySelectorAll('[data-sheet]').forEach(b=>{
  if(b.tagName==='BUTTON') b.addEventListener('click',()=>openSheet(b.dataset.sheet));
});

/* â•â•â•â•â•â•â•â•â•â• SESSION STORAGE â•â•â•â•â•â•â•â•â•â• */
const SESSION_KEY='kufi_session';
const SETTINGS_KEY='kufi_settings';

function saveSession(){
  try{
    const data={
      cols,rows,
      grid:grid.map(r=>[...r]),
      gapH:gapH.map(r=>[...r]),
      gapV:gapV.map(r=>[...r]),
      gapD:gapD.map(r=>[...r]),
      cellColors:{...cellColors},
      gapHColors:{...gapHColors},
      gapVColors:{...gapVColors},
      gapDColors:{...gapDColors},
      drawColor,bgProps:{...bgProps},
      bgImg: bgImg ? bgImg.substring(0,100)+'...' : null, // don't store full image in session
      bgVisible,
      ts:Date.now()
    };
    localStorage.setItem(SESSION_KEY, JSON.stringify(data));
  }catch(e){/* quota exceeded */}
}

function loadSession(data){
  initGrid(data.cols||24, data.rows||24);
  grid=data.grid||grid;
  if(data.gapH)gapH=data.gapH;
  if(data.gapV)gapV=data.gapV;
  if(data.gapD)gapD=data.gapD;
  if(data.cellColors)cellColors=data.cellColors;
  if(data.gapHColors)gapHColors=data.gapHColors;
  if(data.gapVColors)gapVColors=data.gapVColors;
  if(data.gapDColors)gapDColors=data.gapDColors;
  if(data.drawColor){drawColor=data.drawColor;$id('fillColor').value=drawColor;$id('quickColor').value=drawColor;$id('colorPreview').style.background=drawColor; if(typeof buildSwatches==='function')buildSwatches();}
  if(data.bgProps)Object.assign(bgProps,data.bgProps);
  bgVisible=data.bgVisible!==undefined?data.bgVisible:true;
  renderGrid();
}

function saveSettings(){
  const s={cellSz,gapSz,cellRad,drawColor};
  localStorage.setItem(SETTINGS_KEY,JSON.stringify(s));
}
function loadSettings(){
  try{
    const s=JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}');
    if(s.drawColor){drawColor=s.drawColor;$id('fillColor').value=drawColor;$id('quickColor').value=drawColor;$id('colorPreview').style.background=drawColor; if(typeof buildSwatches==='function')buildSwatches();}
    if(s.cellSz){cellSz=s.cellSz;$id('cellSizeR').value=cellSz;$id('cellSizeVal').textContent=cellSz;document.documentElement.style.setProperty('--cell-size',cellSz+'px');}
    if(s.gapSz){gapSz=s.gapSz;$id('gapSizeR').value=gapSz;$id('gapSizeVal').textContent=gapSz;document.documentElement.style.setProperty('--gap',gapSz+'px');}
    if(s.cellRad){cellRad=s.cellRad;$id('cellRadR').value=cellRad;$id('cellRadVal').textContent=cellRad;}
  }catch(e){}
}

// Auto-save session every 30s and on grid changes
let sessionTimer=null;
function scheduleSessionSave(){
  clearTimeout(sessionTimer);
  sessionTimer=setTimeout(saveSession, 2000);
}

/* â•â•â•â•â•â•â•â•â•â• WELCOME SCREEN â•â•â•â•â•â•â•â•â•â• */
function initWelcome(){
  const stored=localStorage.getItem(SESSION_KEY);
  let session=null;
  try{session=stored?JSON.parse(stored):null;}catch(e){}

  if(session && session.ts){
    const age=Math.round((Date.now()-session.ts)/60000);
    const ageStr=age<60?`${age} Ø¯Ù‚ÙŠÙ‚Ø©`:`${Math.round(age/60)} Ø³Ø§Ø¹Ø©`;
    $id('wlRestore').style.display='flex';
    $id('wlRestoreDesc').textContent=`Ù…Ù†Ø° ${ageStr}`;
    $id('wlInfo').textContent=`${session.cols||24}Ã—${session.rows||24} â€¢ Ø¢Ø®Ø± Ø­ÙØ¸ ${ageStr} Ù…Ø¶Øª`;
  }

  $id('wlNew').addEventListener('click',()=>{
    $id('wlNew').style.outline='2px solid var(--accent)';
    $id('wlRestore').style.outline='';
  });
  $id('wlRestore')?.addEventListener('click',()=>{
    $id('wlRestore').style.outline='2px solid var(--accent)';
    $id('wlNew').style.outline='';
  });
  $id('wlLoad').addEventListener('click',()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
    inp.onchange=async e=>{
      const f=e.target.files[0]; if(!f) return;
      const rd=new FileReader();
      rd.onload=ev=>{
        try{
          const d=JSON.parse(ev.target.result);
          loadSession(d);
          enterApp();
        }catch(er){alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù');}
      };
      rd.readAsText(f);
    };
    inp.click();
  });

  $id('wlEnter').addEventListener('click',()=>{
    const restoreSelected=$id('wlRestore').style.outline.includes('accent');
    if(restoreSelected && session){
      loadSession(session);
    }
    enterApp();
  });
  // Default: if session exists, pre-select restore
  if(session) $id('wlRestore').click();
  else $id('wlNew').click();
}

function enterApp(){
  $id('welcomeScreen').classList.add('hidden');
  // Save settings whenever sliders change
  ['cellSizeR','gapSizeR','cellRadR','fillColor'].forEach(id=>{
    const el=$id(id); if(el) el.addEventListener('change',saveSettings);
  });
  scheduleSessionSave();
}

/* â•â•â•â•â•â•â•â•â•â• ACTIONS â•â•â•â•â•â•â•â•â•â• */
$id('btnUndo').addEventListener('click',undo);
$id('btnRedo').addEventListener('click',redo);
$id('btnClear').addEventListener('click',()=>showConfirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ',()=>{
  saveState();
  grid=grid.map(r=>r.map(()=>0));
  gapH=gapH.map(r=>r.map(()=>0));
  gapV=gapV.map(r=>r.map(()=>0));
  gapD=gapD.map(r=>r.map(()=>0));
  cellColors={}; gapHColors={}; gapVColors={}; gapDColors={};
  blocks=[]; document.querySelectorAll('.block-overlay').forEach(e=>e.remove());
  renderGrid();
}));

/* â•â•â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â• */
function exportCanvas(withBg){
  const canvas=document.createElement('canvas');
  const total=cellSz+gapSz, pad=10;
  canvas.width=cols*total+pad*2; canvas.height=rows*total+pad*2;
  const ctx=canvas.getContext('2d');
  // Background
  ctx.fillStyle=getComputedStyle(vp).backgroundColor||'#0A0C10';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // BG image
  if(withBg&&bgImg&&bgVisible){
    const im=new Image(); im.src=bgImg;
    ctx.save();
    ctx.globalAlpha=bgProps.opacity;
    const bm={multiply:'multiply',screen:'screen',overlay:'overlay',lighten:'lighten',darken:'darken',normal:'source-over'};
    ctx.globalCompositeOperation=bm[bgProps.blend]||'source-over';
    const cx=pad+bgProps.x+bgProps.w/(2*zoom), cy=pad+bgProps.y+bgProps.h/(2*zoom);
    ctx.translate(cx,cy); ctx.rotate(bgProps.rotate*Math.PI/180);
    try{ctx.drawImage(im,-bgProps.w/(2*zoom),-bgProps.h/(2*zoom),bgProps.w/zoom,bgProps.h/zoom);}catch(er){}
    ctx.restore();
  }
  // Gap H
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols;gx++){
    if(!gapH[gy][gx]) continue;
    ctx.fillStyle=gapHColors[`${gx},${gy}`]||drawColor;
    ctx.fillRect(pad+gx*total, pad+(gy+1)*total-gapSz, cellSz, gapSz);
  }
  // Gap V
  for(let gy=0;gy<rows;gy++) for(let gx=0;gx<cols-1;gx++){
    if(!gapV[gy][gx]) continue;
    ctx.fillStyle=gapVColors[`${gx},${gy}`]||drawColor;
    ctx.fillRect(pad+(gx+1)*total-gapSz, pad+gy*total, gapSz, cellSz);
  }
  // Gap D
  for(let gy=0;gy<rows-1;gy++) for(let gx=0;gx<cols-1;gx++){
    if(!gapD[gy][gx]) continue;
    ctx.fillStyle=gapDColors[`${gx},${gy}`]||drawColor;
    ctx.fillRect(pad+(gx+1)*total-gapSz, pad+(gy+1)*total-gapSz, gapSz, gapSz);
  }
  // Cells with smart radius
  grid.forEach((row,y)=>row.forEach((v,x)=>{
    if(!v) return;
    ctx.fillStyle=cellColors[`${x},${y}`]||drawColor;
    const rx=pad+x*total, ry=pad+y*total;
    if(cellRad>0){
      const radStr=computeCellRadius(x,y).replace(/px/g,'').split(' ').map(Number);
      const[rtl,rtr,rbr,rbl]=[radStr[0],radStr[1],radStr[2],radStr[3]];
      ctx.beginPath();
      ctx.moveTo(rx+rtl,ry); ctx.lineTo(rx+cellSz-rtr,ry);
      ctx.arcTo(rx+cellSz,ry,rx+cellSz,ry+rtr,rtr);
      ctx.lineTo(rx+cellSz,ry+cellSz-rbr);
      ctx.arcTo(rx+cellSz,ry+cellSz,rx+cellSz-rbr,ry+cellSz,rbr);
      ctx.lineTo(rx+rbl,ry+cellSz);
      ctx.arcTo(rx,ry+cellSz,rx,ry+cellSz-rbl,rbl);
      ctx.lineTo(rx,ry+rtl);
      ctx.arcTo(rx,ry,rx+rtl,ry,rtl);
      ctx.closePath(); ctx.fill();
    } else ctx.fillRect(rx,ry,cellSz,cellSz);
  }));
  const a=document.createElement('a');
  a.download=`kufidraw_${Date.now()}.png`;
  a.href=canvas.toDataURL('image/png'); a.click();
}
$id('exportPNG').addEventListener('click',()=>exportCanvas(false));
$id('exportWithBg').addEventListener('click',()=>exportCanvas(true));
$id('btnExport').addEventListener('click',()=>exportCanvas(true));

/* â•â•â•â•â•â•â•â•â•â• SAVE/LOAD â•â•â•â•â•â•â•â•â•â• */
$id('btnSaveJSON').addEventListener('click',()=>{
  const data={cols,rows,grid,gapH,gapV,gapD,cellColors,gapHColors,gapVColors,gapDColors,drawColor,bgProps,bgImg,bgVisible,v:7};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'}));
  a.download=`kufidraw_${Date.now()}.json`; a.click();
});
$id('btnLoadJSON').addEventListener('click',()=>$id('loadFileInput').click());
$id('loadFileInput').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      initGrid(d.cols||24, d.rows||24);
      grid=d.grid||grid;
      if(d.gapH)gapH=d.gapH; if(d.gapV)gapV=d.gapV; if(d.gapD)gapD=d.gapD;
      if(d.cellColors)cellColors=d.cellColors;
      if(d.gapHColors)gapHColors=d.gapHColors;
      if(d.gapVColors)gapVColors=d.gapVColors;
      if(d.gapDColors)gapDColors=d.gapDColors;
      if(d.drawColor){drawColor=d.drawColor;$id('fillColor').value=drawColor;$id('quickColor').value=drawColor;$id('colorPreview').style.background=drawColor; if(typeof buildSwatches==='function')buildSwatches();}
      if(d.bgProps)Object.assign(bgProps,d.bgProps);
      if(d.bgImg){bgImg=d.bgImg;$id('bgControls').style.display='flex';applyBg();}
      renderGrid();
    }catch(err){alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');}
  };
  rd.readAsText(f); e.target.value='';
});

/* â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â• */
let _cb=null;
function showConfirm(msg,ok){_cb=ok;$id('modalMsg').textContent=msg;$id('modalOverlay').classList.add('open');}
$id('modalOk').addEventListener('click',()=>{$id('modalOverlay').classList.remove('open');if(_cb)_cb();_cb=null;});
$id('modalCancel').addEventListener('click',()=>{$id('modalOverlay').classList.remove('open');_cb=null;});

/* â•â•â•â•â•â•â•â•â•â• KEYBOARD â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undo();}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.shiftKey&&e.key==='Z'))){e.preventDefault();redo();}
  if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();exportCanvas(true);}
  if(!e.ctrlKey&&!e.metaKey){
    if(e.key==='b'||e.key==='B')setTool('draw');
    if(e.key==='e'||e.key==='E')setTool('erase');
    if(e.key==='f'||e.key==='F')setTool('fill');
    if(e.key==='h'||e.key==='H')setTool('pan');
  }
});

/* â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â• */
(async()=>{
  await openDB();
  await loadMergedLetters();
  loadSettings();
  initGrid(24,24);
  buildLetters();
  buildSwatches();
  setTool('draw');
  initRulers();
  // Hook grid changes for session autosave
  const origRenderGrid=renderGrid;
  window.renderGrid=function(){origRenderGrid.apply(this,arguments);scheduleSessionSave?.();};
  initWelcome();
})();

/* â•â•â•â•â•â•â•â•â•â• SERVICE WORKER REGISTRATION â•â•â•â•â•â•â•â•â•â• */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/kufiMaker/sw.js', { scope: '/kufiMaker/' })
      .then(reg => console.log('[SW] Registered, scope:', reg.scope))
      .catch(err => console.warn('[SW] Registration failed:', err));
  });
}
</script>
</body>
</html>
